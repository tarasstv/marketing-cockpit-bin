<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BINOKL ‚Ä¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-–û–° v3 ‚Ä¢ –ü–ª–∞–Ω/–§–∞–∫—Ç/–ü—Ä–æ–≥–Ω–æ–∑ ‚Ä¢ Old+New Optimizers ‚Ä¢ Google Sheets Sync</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --card:#101e34;
      --line:rgba(255,255,255,.09);
      --text:#e8eef7;
      --muted:#9db0c8;
      --good:#42d18d;
      --warn:#ffcc66;
      --bad:#ff6b7a;
      --accent:#6bb7b8;
      --accent2:#8a7dff;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 12% 8%, rgba(107,183,184,.18), transparent 58%),
        radial-gradient(900px 520px at 86% 12%, rgba(138,125,255,.14), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #0b1220 45%, #070e1a 100%);
    }
    .app{max-width:1700px;margin:0 auto;padding:16px 14px 32px;}
    .top{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(107,183,184,.85), rgba(138,125,255,.65));
      box-shadow: var(--shadow);
      display:grid;place-items:center;font-weight:1000;letter-spacing:.5px;
      flex:0 0 auto;
    }
    .title{min-width:260px;max-width:980px}
    .title h1{margin:0;font-size:clamp(16px, 1.35vw, 19px);line-height:1.15}
    .title .sub{color:var(--muted);font-size:12.5px;margin-top:4px;line-height:1.35}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);
      padding:10px 12px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,.18);
      font-weight:1000;font-size:12.5px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.13)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(107,183,184,.14);border-color:rgba(107,183,184,.32)}
    .btn.danger{background:rgba(255,107,122,.12);border-color:rgba(255,107,122,.28)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);background:rgba(255,255,255,.035);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--text);font-weight:1000;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);cursor:pointer;font-weight:1000;font-size:12.5px;color:var(--muted);
      user-select:none;
    }
    .tab.active{color:var(--text);background:rgba(107,183,184,.12);border-color:rgba(107,183,184,.28);}

    .grid{
      display:grid;grid-template-columns:minmax(0, 1.2fr) minmax(0, .8fr);
      gap:12px;margin-top:10px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.025));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width:0;
    }
    .hd{
      padding:12px 14px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
    }
    .h{font-weight:1000;letter-spacing:.2px}
    .hint{color:var(--muted);font-size:12px}
    .bd{padding:12px 14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .ctl{
      display:flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      min-width:fit-content;
    }
    .ctl label{font-size:12px;color:var(--muted);font-weight:900;}
    .ctl input,.ctl select{
      background:transparent;border:none;outline:none;color:var(--text);
      font-weight:1000;font-size:12.5px;min-width:120px;
    }
    .ctl input[type="number"]{width:140px;min-width:140px}
    .ctl .suffix{color:var(--muted);font-weight:900;font-size:12px;margin-left:-4px}

    .kpi{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap:10px;
    }
    .k{
      padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.12);
      position:relative;overflow:hidden;min-width:0;
    }
    .k .t{color:var(--muted);font-size:12px;font-weight:900}
    .k .v{font-size:20px;font-weight:1000;margin-top:6px;letter-spacing:.2px}
    .k .s{color:var(--muted);font-size:12px;margin-top:2px;line-height:1.25}
    .k.good:before,.k.warn:before,.k.bad:before{
      content:"";position:absolute;inset:-40px -40px auto auto;width:120px;height:120px;border-radius:999px;filter:blur(20px);
      opacity:.18;
    }
    .k.good:before{background:var(--good)}
    .k.warn:before{background:var(--warn)}
    .k.bad:before{background:var(--bad)}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;font-weight:1000;
    }
    .badge.good{border-color:rgba(66,209,141,.25);background:rgba(66,209,141,.10)}
    .badge.warn{border-color:rgba(255,204,102,.25);background:rgba(255,204,102,.10)}
    .badge.bad{border-color:rgba(255,107,122,.25);background:rgba(255,107,122,.10)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .two{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
    @media (max-width:950px){.two{grid-template-columns:1fr}}
    canvas{width:100%;height:280px;background:rgba(0,0,0,.08);border:1px solid var(--line);border-radius:14px}
    .mini{font-size:12px;color:var(--muted);line-height:1.35}
    .noteBox{
      border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.10);
      padding:12px;color:var(--muted);line-height:1.45;font-size:12.5px;
    }
    .noteBox b{color:var(--text)}

    .sheetWrap{overflow:auto;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.10)}
    table.sheet{border-collapse:separate;border-spacing:0;width:100%;min-width:1150px;}
    .sheet th,.sheet td{border-bottom:1px solid rgba(255,255,255,.07);border-right:1px solid rgba(255,255,255,.06);padding:0;vertical-align:middle}
    .sheet th{
      position:sticky;top:0;z-index:2;
      background:rgba(9,16,30,.92);
      font-size:12px;color:var(--muted);font-weight:1000;text-align:left;
      padding:10px 10px;white-space:nowrap;
    }
    .sheet th:first-child{left:0;position:sticky;z-index:3;background:rgba(9,16,30,.95);}
    .sheet td:first-child{
      left:0;position:sticky;z-index:1;background:rgba(10,18,32,.95);
      padding:10px 10px;font-weight:1000;color:var(--text);
      border-right:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .cell{
      width:100%;padding:10px 10px;background:transparent;border:0;color:var(--text);
      font-weight:1000;font-size:12.5px;outline:none;
    }
    .cell::placeholder{color:rgba(157,176,200,.35);font-weight:900}
    .cell:focus{background:rgba(107,183,184,.10)}
    .cell.num{text-align:right;font-variant-numeric:tabular-nums;}
    .toast{
      position:fixed;left:14px;bottom:14px;
      max-width:min(720px, calc(100vw - 28px));
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(9,16,30,.90);
      box-shadow: var(--shadow);
      color:rgba(232,238,247,.95);
      font-size:12.5px;line-height:1.35;
      display:none;z-index:9999;
    }
    .toast b{color:var(--text)}

    .modal{
      position:fixed;inset:0;display:none;place-items:center;z-index:99999;
      background:rgba(0,0,0,.55);
      padding:18px;
    }
    .modal .box{
      width:min(520px, 100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(9,16,30,.96);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px 0;font-size:15px}
    .modal p{margin:0 0 10px 0;color:var(--muted);font-size:12.5px;line-height:1.4}
    .modal input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
      margin-bottom:10px;
    }
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .lockNote{
      display:inline-flex;gap:8px;align-items:center;
      color:rgba(255,204,102,.95);
      border:1px solid rgba(255,204,102,.25);
      background:rgba(255,204,102,.07);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:1000;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div class="title">
        <h1>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-–û–° ‚Ä¢ –ü–ª–∞–Ω/–§–∞–∫—Ç/–ü—Ä–æ–≥–Ω–æ–∑ ‚Ä¢ Old+New Optimizers ‚Ä¢ Sync via Google Sheets</h1>
        <div class="sub">
          –†–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏: <b>–ü–ª–∞–Ω –º—ñ—Å—è—Ü—è</b> ‚Üí (Old –∞–±–æ New –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä) ‚Üí <b>–§–∞–∫—Ç –ø–æ —Ç–∏–∂–Ω—è—Ö</b> ‚Üí <b>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –∫–æ—Ä–µ–∫—Ü—ñ—è</b>.
          –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ Google Sheets —á–µ—Ä–µ–∑ —Ç–≤—ñ–π Apps Script —ñ –≤–∏–¥–∏–º—ñ –Ω–∞ –≤—Å—ñ—Ö –≥–∞–¥–∂–µ—Ç–∞—Ö.
        </div>
      </div>
    </div>

    <div class="toolbar">
      <span class="pill"><strong id="monthPill">‚Äî</strong><span class="muted">‚Ä¢ –ü–ª–∞–Ω/–§–∞–∫—Ç</span></span>
      <span class="pill"><strong id="cloudPill">Cloud: ‚Äî</strong><span class="muted" id="cloudSub">‚Äî</span></span>
      <span class="pill"><strong id="editPill">Edit: ‚Äî</strong><span class="muted">‚Ä¢ –ø–∞—Ä–æ–ª—å</span></span>
      <button class="btn small" id="btnUnlock">–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</button>
      <button class="btn small" id="btnLock">–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
      <button class="btn small" id="btnCloudPull">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ Cloud</button>
      <button class="btn small" id="btnCloudPush">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ Cloud</button>
      <button class="btn small" id="btnExport">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button class="btn small" id="btnImport">–Ü–º–ø–æ—Ä—Ç JSON</button>
      <button class="btn danger" id="btnReset">–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ</button>
      <button class="btn small" id="btnHelp">–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å</button>
    </div>
  </div>

  <div class="tabs" id="tabs"></div>

  <!-- DASH -->
  <section class="grid" id="tab-dash">
    <div class="card">
      <div class="hd">
        <div>
          <div class="h">–î–∞—à–±–æ—Ä–¥ –º—ñ—Å—è—Ü—è</div>
          <div class="hint">–ü–ª–∞–Ω/–§–∞–∫—Ç/–ü—Ä–æ–≥–Ω–æ–∑ + funnel + —ñ—Å—Ç–æ—Ä—ñ—è –º—ñ—Å—è—Ü—ñ–≤</div>
        </div>

        <div class="row">
          <div class="ctl">
            <label>–ú—ñ—Å—è—Ü—å</label>
            <select id="monthKey"></select>
          </div>
          <div class="ctl">
            <label>–¢–∏–∂–Ω—ñ–≤</label>
            <select id="weeksInMonth">
              <option>4</option>
              <option>5</option>
            </select>
          </div>
          <div class="ctl">
            <label>KPI</label>
            <select id="kpiMode">
              <option value="sales" selected>–ü—Ä–æ–¥–∞–∂—ñ</option>
              <option value="tlead">–¶—ñ–ª—å–æ–≤—ñ –ª—ñ–¥–∏</option>
            </select>
          </div>
          <div class="ctl">
            <label>–¢–∏–∂–¥–µ–Ω—å</label>
            <select id="weekSel"></select>
          </div>
        </div>

        <div class="row" style="width:100%">
          <div class="ctl">
            <label>–ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂—ñ–≤</label>
            <input id="planSales" type="number" min="0" step="1" />
            <span class="suffix">—à—Ç</span>
          </div>
          <div class="ctl">
            <label>–ü–ª–∞–Ω —Ü—ñ–ª—å–æ–≤–∏—Ö</label>
            <input id="planTLeads" type="number" min="0" step="1" />
            <span class="suffix">—à—Ç</span>
          </div>
          <div class="ctl">
            <label>–ü–ª–∞–Ω –±—é–¥–∂–µ—Ç—É</label>
            <input id="planBudget" type="number" min="0" step="100" />
            <span class="suffix">–≥—Ä–Ω</span>
          </div>

          <button class="btn primary" id="btnRecalc">–ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        </div>
      </div>

      <div class="bd">
        <div class="kpi" id="kpis"></div>

        <div class="row" style="margin-top:10px">
          <span class="badge" id="paceBadge">–¢–µ–º–ø: ‚Äî</span>
          <span class="badge" id="bottleBadge">–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ: ‚Äî</span>
          <span class="badge" id="weekBadge">–¢–∏–∂–Ω—ñ: ‚Äî</span>
          <span class="lockNote" id="lockNote" style="display:none">üîí –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ (–ª–∏—à–µ –ø–µ—Ä–µ–≥–ª—è–¥)</span>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <canvas id="chartMain" width="1100" height="360"></canvas>
            <div class="mini" style="margin-top:8px">
              –ì—Ä–∞—Ñ—ñ–∫ ‚Ññ1: <b>–ü–ª–∞–Ω vs –§–∞–∫—Ç vs –ü—Ä–æ–≥–Ω–æ–∑</b> (KPI + –±—é–¥–∂–µ—Ç)
            </div>
          </div>
          <div>
            <canvas id="chartFunnel" width="1100" height="360"></canvas>
            <div class="mini" style="margin-top:8px">
              –ì—Ä–∞—Ñ—ñ–∫ ‚Ññ2: <b>–í–æ—Ä–æ–Ω–∫–∞</b> (–õ—ñ–¥–∏ ‚Üí –¶—ñ–ª—å–æ–≤—ñ ‚Üí –ü—Ä–æ–¥–∞–∂—ñ) + –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (CPL/CQL/CPS)
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <canvas id="chartChannels" width="1100" height="360"></canvas>
            <div class="mini" style="margin-top:8px">
              –ì—Ä–∞—Ñ—ñ–∫ ‚Ññ3: <b>–ö–∞–Ω–∞–ª–∏</b> ‚Äî –¥–µ –±–µ—Ä–µ—Ç—å—Å—è KPI (–ø–ª–∞–Ω/—Ñ–∞–∫—Ç/–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –≥—Ä—É–ø–∞—Ö)
            </div>
          </div>
          <div>
            <canvas id="chartHistory" width="1100" height="360"></canvas>
            <div class="mini" style="margin-top:8px">
              –ì—Ä–∞—Ñ—ñ–∫ ‚Ññ4: <b>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ –º—ñ—Å—è—Ü—è—Ö</b> (KPI —ñ –±—é–¥–∂–µ—Ç)
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="noteBox" id="weeklyConclusionBox"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <div class="h">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –∫–æ—Ä–µ–∫—Ü—ñ—è (–ø—ñ—Å–ª—è —Ñ–∞–∫—Ç—É)</div>
          <div class="hint">–°–∫–∞–∂—É —á–µ—Å–Ω–æ: ‚Äú–±—é–¥–∂–µ—Ç –ª—ñ–∫—É—î‚Äù —á–∏ ‚Äú–ø—Ä–æ–¥–∞–∂—ñ –ª—ñ–∫—É—é—Ç—å‚Äù. –Ü –¥–∞–º –ø–∞—Ç—á –ø–æ –ø–ª–∞–Ω—É.</div>
        </div>
        <div class="row">
          <button class="btn primary" id="btnFixCalc">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ü—ñ—é</button>
          <button class="btn small" id="btnFixApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤ –ø–ª–∞–Ω</button>
        </div>
      </div>
      <div class="bd">
        <div class="noteBox" id="fixBox">
          1) –í–Ω–µ—Å–∏ —Ñ–∞–∫—Ç –∑–∞ —Ç–∏–∂–¥–µ–Ω—å —É –≤–∫–ª–∞–¥—Ü—ñ <b>–í–≤—ñ–¥</b>.<br>
          2) –ü–æ–≤–µ—Ä–Ω–∏—Å—å ‚Üí <b>–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ü—ñ—é</b>.<br>
          3) –Ø–∫—â–æ –æ–∫ ‚Äî <b>–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</b> (–æ–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö).
        </div>
        <div class="hr"></div>
        <div class="mini">
          –ü—Ä–∞–≤–∏–ª–æ: —è–∫—â–æ –≤—É–∑—å–∫–µ –º—ñ—Å—Ü–µ <b>CR —É –ø—Ä–æ–¥–∞–∂</b> ‚Äî –Ω–µ ‚Äú–¥–æ–¥–∞—î–º–æ –±—é–¥–∂–µ—Ç‚Äù, –∞ —Ñ—ñ–∫—Å–∏–º–æ –ø—Ä–æ–¥–∞–∂—ñ (—à–≤–∏–¥–∫—ñ—Å—Ç—å, —Å–∫—Ä–∏–ø—Ç, –∫–æ–Ω—Ç—Ä–æ–ª—å).
        </div>
      </div>
    </div>
  </section>

  <!-- INPUT -->
  <section class="card" id="tab-input" style="display:none">
    <div class="hd">
      <div>
        <div class="h">–í–≤—ñ–¥ (–ª–µ–≥–∫–æ): –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö + —Ñ–∞–∫—Ç –ø–æ —Ç–∏–∂–Ω—é</div>
        <div class="hint">–ü—ñ–¥—Ç—Ä–∏–º—É—î Ctrl+V –∑ Google Sheets. –õ—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ ‚Äî –ø–ª–∞–Ω –º—ñ—Å—è—Ü—è, –ø—Ä–∞–≤–∞ ‚Äî —Ñ–∞–∫—Ç –æ–±—Ä–∞–Ω–æ–≥–æ —Ç–∏–∂–Ω—è.</div>
      </div>
      <div class="row">
        <button class="btn primary" id="btnPlanOld">Old Optimizer ‚Üí –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="btnPlanNew">New Optimizer ‚Üí –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
        <button class="btn small" id="btnClearWeek">–û–±–Ω—É–ª–∏—Ç–∏ –æ–±—Ä–∞–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å</button>
        <button class="btn small" id="btnPasteMode">–í—Å—Ç–∞–≤–∫–∞: <span id="pasteModeLbl">–£–í–Ü–ú–ö</span></button>
      </div>
      <div class="row" style="width:100%">
        <span class="pill"><strong>–ü–ª–∞–Ω</strong><span class="muted">–±—é–¥–∂–µ—Ç, –æ—á—ñ–∫—É–≤–∞–Ω–∏–π CPL/Q/CR, –ª—ñ–º—ñ—Ç</span></span>
        <span class="pill"><strong>–§–∞–∫—Ç</strong><span class="muted">–ø–æ —Ç–∏–∂–Ω—è—Ö: –±—é–¥–∂–µ—Ç, –ª—ñ–¥–∏, —è–∫—ñ—Å—Ç—å, –ø—Ä–æ–¥–∞–∂—ñ</span></span>
        <span class="pill"><strong>–ö–∞–Ω–∞–ª–∏</strong><span class="muted">Google / Meta / TikTok / Organic / Other</span></span>
      </div>
    </div>
    <div class="bd">
      <div class="sheetWrap">
        <table class="sheet" id="sheet"></table>
      </div>
      <div class="mini" style="margin-top:10px">
        –†–æ–±–æ—á–µ –ø—Ä–∞–≤–∏–ª–æ: —â–æ–ø–æ–Ω–µ–¥—ñ–ª–∫–∞ –¥–æ 12:00 ‚Äî –≤–Ω–µ—Å–ª–∏ —Ñ–∞–∫—Ç ‚Üí —Ç–∏ –Ω–∞—Ç–∏—Å–Ω—É–≤ –∫–æ—Ä–µ–∫—Ü—ñ—é ‚Üí –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞—Ü—é—î –ø–æ –æ–¥–Ω–æ–º—É –ø–ª–∞–Ω—É.
      </div>
    </div>
  </section>

  <!-- OLD OPTIMIZER -->
  <section class="card" id="tab-old" style="display:none">
    <div class="hd">
      <div>
        <div class="h">–°—Ç–∞—Ä–∏–π –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä (Classic / Baseline)</div>
        <div class="hint">–°—É—Ö–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥ –±–∞–∑–æ–≤–∏—Ö —Ü–∏—Ñ—Ä (CPL/Q/CR) –∑ –ª—ñ–º—ñ—Ç–∞–º–∏ –∫–∞–Ω–∞–ª—ñ–≤. –ë–µ–∑ ‚Äú–º–∞–≥—ñ—ó‚Äù.</div>
      </div>
      <div class="row">
        <button class="btn primary" id="btnOldPreview">–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button class="btn small" id="btnOldApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤ –ø–ª–∞–Ω</button>
      </div>
    </div>
    <div class="bd">
      <div class="noteBox" id="oldBox">–ù–∞—Ç–∏—Å–Ω–∏ <b>–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</b> ‚Äî –æ—Ç—Ä–∏–º–∞—î—à —Ä–æ–∑–∫–ª–∞–¥ –±—é–¥–∂–µ—Ç—É/–ª—ñ–¥—ñ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞—Ö.</div>
      <div class="hr"></div>
      <canvas id="chartOld" width="1100" height="360"></canvas>
    </div>
  </section>

  <!-- NEW OPTIMIZER -->
  <section class="card" id="tab-new" style="display:none">
    <div class="hd">
      <div>
        <div class="h">–ù–æ–≤–∏–π –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä (Operational / Current)</div>
        <div class="hint">–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤—ñ–¥ —Ä–µ–∞–ª—å–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤: –±–µ—Ä–µ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑ –º–∏–Ω—É–ª–æ–≥–æ –º—ñ—Å—è—Ü—è + –ø—ñ–¥–º—ñ—à—É—î –±–∞–∑—É. –î–∞—î ‚Äú—Ä–æ–±–æ—á–∏–π –ø–ª–∞–Ω‚Äù.</div>
      </div>
      <div class="row">
        <div class="ctl">
          <label>–ú—ñ—Å—è—Ü—å-–±–∞–∑–∞</label>
          <select id="newBaseMonth"></select>
        </div>
        <div class="ctl">
          <label>–ó–º—ñ—à—É–≤–∞–Ω–Ω—è</label>
          <select id="blendMode">
            <option value="70_30" selected>70% —Ñ–∞–∫—Ç + 30% –±–∞–∑–∞</option>
            <option value="50_50">50% —Ñ–∞–∫—Ç + 50% –±–∞–∑–∞</option>
            <option value="90_10">90% —Ñ–∞–∫—Ç + 10% –±–∞–∑–∞</option>
            <option value="base_only">0% —Ñ–∞–∫—Ç + 100% –±–∞–∑–∞</option>
            <option value="fact_only">100% —Ñ–∞–∫—Ç + 0% –±–∞–∑–∞</option>
          </select>
        </div>
        <button class="btn primary" id="btnNewPreview">–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button class="btn small" id="btnNewApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤ –ø–ª–∞–Ω</button>
      </div>
    </div>
    <div class="bd">
      <div class="noteBox" id="newBox">–ù–∞—Ç–∏—Å–Ω–∏ <b>–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</b> ‚Äî –æ—Ç—Ä–∏–º–∞—î—à –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–∏–Ω—É–ª–æ–≥–æ –º—ñ—Å—è—Ü—è.</div>
      <div class="hr"></div>
      <canvas id="chartNew" width="1100" height="360"></canvas>
    </div>
  </section>

  <!-- SETTINGS -->
  <section class="card" id="tab-settings" style="display:none">
    <div class="hd">
      <div>
        <div class="h">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ</div>
        <div class="hint">–¢—É—Ç ‚Äú–¥–≤–∏–≥—É–Ω‚Äù: –±–∞–∑–æ–≤—ñ CPL/Q/CR —ñ –ª—ñ–º—ñ—Ç–∏ –ø–æ –∫–∞–Ω–∞–ª–∞—Ö. –ú—ñ–Ω—è–π –ª–∏—à–µ –∫–æ–ª–∏ —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω–∏–ª–∞—Å—å.</div>
      </div>
      <div class="row">
        <button class="btn small" id="btnAutoCalibrate">–ê–≤—Ç–æ–∫–∞–ª—ñ–±—Ä—É–≤–∞—Ç–∏ –∑ —Ñ–∞–∫—Ç—É (–æ–±–µ—Ä–µ–∂–Ω–æ)</button>
      </div>
    </div>
    <div class="bd" id="settingsBox"></div>
  </section>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fileImport" accept="application/json" style="display:none" />

<!-- Password modal -->
<div class="modal" id="pwModal">
  <div class="box">
    <h3>–ü–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
    <p>–ë–µ–∑ –ø–∞—Ä–æ–ª—è ‚Äî —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥. –ó –ø–∞—Ä–æ–ª–µ–º ‚Äî —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.</p>
    <input id="pwInput" type="password" placeholder="–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å" autocomplete="current-password" />
    <div class="actions">
      <button class="btn" id="pwCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn primary" id="pwOk">–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   0) CLOUD + PASSWORD
========================================================= */
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbyNvynuk_huHSh5w49PNSKculxo04meRVCi3rAhACok7H3z25wsnqWtYmb1Pz95VsSEEw/exec";
const CLOUD_KEY = "BINOKL_SUPER_SECRET_KEY_2026";
const ADMIN_PASSWORD_SHA256_HEX = "db6ec3fde0265a91ea1e541baa84823a1c836c24e9c0d066e14c4a8978b9f2ae";

const STORAGE_KEY="binokl_marketing_os_v3_local";
const SESSION_EDIT_KEY="binokl_marketing_os_v3_edit_unlocked";

async function sha256Hex(str){
  const enc=new TextEncoder().encode(str);
  const buf=await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

function toast(html, ms=2600){
  const t=document.getElementById("toast");
  t.innerHTML=html; t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none", ms);
}

const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const n=(x)=> (isFinite(+x)? +x : 0);
const fmt = {
  int:(x)=> (isFinite(x)? Math.round(x).toLocaleString("uk-UA") : "‚Äî"),
  num:(x,d=2)=> (isFinite(x)? (+x).toLocaleString("uk-UA",{maximumFractionDigits:d, minimumFractionDigits:d}) : "‚Äî"),
  uah:(x)=> (isFinite(x)? Math.round(x).toLocaleString("uk-UA")+" –≥—Ä–Ω" : "‚Äî"),
  pct01:(x)=> (isFinite(x)? Math.round(x*100)+"%" : "‚Äî"),
};

function debounce(fn, ms){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* =========================================================
   1) –ú–û–î–ï–õ–¨ –ö–ê–ù–ê–õ–Ü–í
========================================================= */
const GROUPS = [
  { key:"google",  name:"Google (Search/PMax/YT)" },
  { key:"meta",    name:"Meta" },
  { key:"tiktok",  name:"TikTok" },
  { key:"organic", name:"Organic / Direct / Ref" },
  { key:"other",   name:"–Ü–Ω—à–µ" },
];

const BASE_MODEL = {
  google:  { maxLeads:260, cpl:850,  q:0.33, cr:0.07 },
  meta:    { maxLeads:380, cpl:740,  q:0.40, cr:0.10 },
  tiktok:  { maxLeads:140, cpl:950,  q:0.30, cr:0.08 },
  organic: { maxLeads:120, cpl:0,    q:0.60, cr:0.14 },
  other:   { maxLeads:120, cpl:1200, q:0.25, cr:0.06 },
};

const SEASON = {
  "2026-01": {label:"–°—ñ—á–µ–Ω—å 2026", cpl:1.10, q:0.95, cr:0.90},
  "2026-02": {label:"–õ—é—Ç–∏–π 2026",  cpl:0.95, q:1.05, cr:1.10},
  "2026-03": {label:"–ë–µ—Ä–µ–∑–µ–Ω—å 2026",cpl:0.98, q:1.02, cr:1.03},
  "2026-04": {label:"–ö–≤—ñ—Ç–µ–Ω—å 2026", cpl:1.00, q:1.00, cr:1.00},
  "2026-05": {label:"–¢—Ä–∞–≤–µ–Ω—å 2026", cpl:1.00, q:1.00, cr:1.00},
  "2026-06": {label:"–ß–µ—Ä–≤–µ–Ω—å 2026", cpl:1.00, q:1.00, cr:1.00},
};
function monthLabel(k){ return (SEASON[k]?.label) || k; }

function applySeason(model, monthKey){
  const s = SEASON[monthKey] || {cpl:1,q:1,cr:1};
  return {
    cpl: Math.max(0, n(model.cpl) * s.cpl),
    q: clamp(n(model.q) * s.q, 0, 1),
    cr: clamp(n(model.cr) * s.cr, 0, 1),
    maxLeads: Math.max(0, n(model.maxLeads))
  };
}

/* =========================================================
   2) STATE
========================================================= */
function emptyMonth(monthKey){
  const groups = GROUPS.map(g=>{
    const m = BASE_MODEL[g.key];
    return {
      key:g.key,
      planBudget:0,
      planLeads:0,
      planCPL:m.cpl,
      planQ:m.q,
      planCR:m.cr,
      maxLeads:m.maxLeads,
      weeks: Array.from({length:5}, ()=>({budget:0, leads:0, q:m.q, sales:0})),
    };
  });
  return {
    monthKey,
    weeksInMonth:4,
    kpiMode:"sales",
    planSales:10,
    planTLeads:120,
    planBudget:0,
    groups,
    closed:false,
    closedAt:null,
  };
}

function freshState(){
  const months = ["2026-01","2026-02","2026-03","2026-04"];
  const byKey = {};
  months.forEach(k=>byKey[k]=emptyMonth(k));
  return {
    version:"3.0.0",
    cloudKey:CLOUD_KEY,
    activeMonth:"2026-01",
    historyOrder: months,
    months: byKey,
    pasteHot:true,
    lastWeeklyFix:null,
    cloudMeta:{ lastPullAt:0, lastPushAt:0, lastServerAt:0, status:"idle", msg:"" },
  };
}

function loadLocalState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return freshState();
    const s=JSON.parse(raw);
    if(!s || !s.months || !s.activeMonth) return freshState();
    return normalizeState(s);
  }catch(e){
    return freshState();
  }
}

function normalizeState(s){
  if(!Array.isArray(s.historyOrder) || !s.historyOrder.length) s.historyOrder=Object.keys(s.months||{}).sort();
  if(!s.months) s.months={};
  s.historyOrder.forEach(k=>{ if(!s.months[k]) s.months[k]=emptyMonth(k); });
  Object.keys(s.months).forEach(k=>{
    const m=s.months[k];
    if(!m.groups || !Array.isArray(m.groups)) m.groups=emptyMonth(k).groups;
    const by=new Map(m.groups.map(x=>[x.key,x]));
    m.groups=GROUPS.map(g=>{
      const old=by.get(g.key);
      const base=BASE_MODEL[g.key];
      const weeks=(old?.weeks && Array.isArray(old.weeks))? old.weeks.slice(0,5):[];
      while(weeks.length<5) weeks.push({budget:0,leads:0,q:base.q,sales:0});
      return {
        key:g.key,
        planBudget:Math.max(0,n(old?.planBudget)),
        planLeads:Math.max(0,n(old?.planLeads)),
        planCPL:Math.max(0,n(old?.planCPL || base.cpl)),
        planQ:clamp(n(old?.planQ ?? base.q),0,1),
        planCR:clamp(n(old?.planCR ?? base.cr),0,1),
        maxLeads:Math.max(0,n(old?.maxLeads ?? base.maxLeads)),
        weeks:weeks.map(w=>({budget:Math.max(0,n(w.budget)), leads:Math.max(0,n(w.leads)), q:clamp(n(w.q),0,1), sales:Math.max(0,n(w.sales))})),
      };
    });
    if(!m.weeksInMonth) m.weeksInMonth=4;
    if(!m.kpiMode) m.kpiMode="sales";
    if(!("planSales" in m)) m.planSales=10;
    if(!("planTLeads" in m)) m.planTLeads=120;
    if(!("planBudget" in m)) m.planBudget=0;
    if(!("closed" in m)) m.closed=false;
  });
  if(!s.cloudMeta) s.cloudMeta={ lastPullAt:0, lastPushAt:0, lastServerAt:0, status:"idle", msg:"" };
  if(!("pasteHot" in s)) s.pasteHot=true;
  return s;
}

let state = loadLocalState();
function saveLocalState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function isEditUnlocked(){
  return sessionStorage.getItem(SESSION_EDIT_KEY)==="1";
}
function setEditUnlocked(on){
  if(on) sessionStorage.setItem(SESSION_EDIT_KEY,"1");
  else sessionStorage.removeItem(SESSION_EDIT_KEY);
  updateEditUI();
  lockInputs();
}

function updateEditUI(){
  const on=isEditUnlocked();
  document.getElementById("editPill").textContent = "Edit: " + (on ? "ON" : "OFF");
  document.getElementById("lockNote").style.display = on ? "none" : "inline-flex";
}

function lockInputs(){
  const locked = !isEditUnlocked();
  const allowIds = new Set([
    "btnHelp","btnUnlock","btnLock","btnCloudPull","btnExport","btnImport","fileImport",
    "monthKey","weekSel",
  ]);
  document.querySelectorAll("input, select, button").forEach(el=>{
    const id=el.id||"";
    if(allowIds.has(id)) return;

    // Preview/–ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –¥–æ–∑–≤–æ–ª—è—î–º–æ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ locked (–∞–ª–µ –±–µ–∑ –∑–º—ñ–Ω–∏ state)
    const previewIds = new Set(["btnFixCalc","btnOldPreview","btnNewPreview","btnRecalc"]);
    if(previewIds.has(id)){
      el.disabled=false;
      return;
    }

    // –ö—Ä–∏—Ç–∏—á–Ω—ñ write-–¥—ñ—ó
    const writeIds = new Set([
      "btnCloudPush","btnReset","btnFixApply","btnOldApply","btnNewApply",
      "btnPlanOld","btnPlanNew","btnClearWeek","btnAutoCalibrate"
    ]);

    if(writeIds.has(id)){
      el.disabled = locked;
      return;
    }

    // –ü–æ–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    if(el.classList.contains("cell") || id==="planSales" || id==="planTLeads" || id==="planBudget" || id==="weeksInMonth" || id==="kpiMode" || id==="btnPasteMode"){
      el.disabled = locked;
      return;
    }

    // –Ü–Ω—à—ñ –∫–Ω–æ–ø–∫–∏/—Å–µ–ª–µ–∫—Ç–∏ ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ —î
  });
}

/* =========================================================
   3) CLOUD API
========================================================= */
async function cloudFetchJson(url, opts){
  const r = await fetch(url, opts);
  const text = await r.text();
  try{
    return JSON.parse(text);
  }catch(e){
    const m = text.match(/\{[\s\S]*\}/);
    if(m){
      try{ return JSON.parse(m[0]); }catch(_){}
    }
    return { ok:false, raw:text, status:r.status };
  }
}

async function cloudLoad(){
  const variants = [
    CLOUD_URL + "?key=" + encodeURIComponent(CLOUD_KEY),
    CLOUD_URL + "?action=load&key=" + encodeURIComponent(CLOUD_KEY),
    CLOUD_URL + "?action=get&key=" + encodeURIComponent(CLOUD_KEY),
    CLOUD_URL + "?k=" + encodeURIComponent(CLOUD_KEY),
  ];
  for(const u of variants){
    const j = await cloudFetchJson(u, {method:"GET", cache:"no-store"});
    const s = j?.state || j?.data?.state || (j?.months ? j : null);
    if(s && s.months && s.activeMonth){
      return { ok:true, state: normalizeState(s), meta:j };
    }
  }
  return { ok:false, state:null, meta:null };
}

async function cloudSave(s){
  const payload = { key:CLOUD_KEY, updatedAt: Date.now(), state: s };
  const j = await cloudFetchJson(CLOUD_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  return { ok: !!(j?.ok ?? true), meta:j };
}

function setCloudStatus(status, msg){
  state.cloudMeta.status=status;
  state.cloudMeta.msg=msg||"";
  saveLocalState();
  renderCloudPill();
}

function renderCloudPill(){
  const pill=document.getElementById("cloudPill");
  const sub=document.getElementById("cloudSub");
  const st=state.cloudMeta?.status||"idle";
  pill.textContent = "Cloud: " + st.toUpperCase();
  sub.textContent = state.cloudMeta?.msg || "";
}

/* =========================================================
   4) COMPUTE
========================================================= */
function getMonth(){ return state.months[state.activeMonth]; }

function weeksUsed(month){
  const W=n(month.weeksInMonth);
  let used=0;
  for(let i=0;i<W;i++){
    const has = month.groups.some(g=>{
      const w=g.weeks[i]||{};
      return n(w.budget)>0 || n(w.leads)>0 || n(w.sales)>0;
    });
    if(has) used=i+1;
  }
  return used;
}

function sumFactForGroup(gr, weeksCount){
  const w=gr.weeks.slice(0,weeksCount);
  const budget=w.reduce((a,x)=>a+n(x.budget),0);
  const leads=w.reduce((a,x)=>a+n(x.leads),0);
  const q = leads>0 ? w.reduce((a,x)=>a+n(x.leads)*n(x.q),0)/leads : n(gr.planQ);
  const sales=w.reduce((a,x)=>a+n(x.sales),0);
  const tLeads = leads*q;
  const cpl = leads>0 ? budget/leads : NaN;
  const cql = tLeads>0 ? budget/tLeads : NaN;
  const cr = tLeads>0 ? sales/tLeads : NaN;
  const cps = sales>0 ? budget/sales : NaN;
  return {budget,leads,q,tLeads,sales,cpl,cql,cr,cps};
}

function computeMonth(monthKey){
  const month = state.months[monthKey];
  const W=n(month.weeksInMonth);
  const used=weeksUsed(month);

  const per = month.groups.map(gr=>{
    const base = applySeason(BASE_MODEL[gr.key], monthKey);

    const plan = {
      budget:n(gr.planBudget),
      leads:n(gr.planLeads),
      cpl: Math.max(0,n(gr.planCPL || base.cpl)),
      q: clamp(n(gr.planQ),0,1),
      cr: clamp(n(gr.planCR),0,1),
      maxLeads: Math.max(0,n(gr.maxLeads ?? base.maxLeads)),
    };
    if(plan.leads<=0 && plan.budget>0 && plan.cpl>0) plan.leads = plan.budget/plan.cpl;
    plan.tLeads = plan.leads*plan.q;
    plan.sales  = plan.tLeads*plan.cr;
    plan.cpl_eff = plan.leads>0 ? plan.budget/plan.leads : (plan.cpl>0?plan.cpl:NaN);
    plan.cql = plan.tLeads>0 ? plan.budget/plan.tLeads : NaN;
    plan.cps = plan.sales>0 ? plan.budget/plan.sales : NaN;

    const fact = sumFactForGroup(gr, used);

    const pace = used>0 ? (W/used) : 0;
    const fore = {};
    fore.leads  = used>0 ? fact.leads*pace : plan.leads;
    fore.budget = used>0 ? fact.budget*pace : plan.budget;

    const effCPL = (isFinite(fact.cpl) && fact.cpl>0) ? fact.cpl : (isFinite(plan.cpl_eff)&&plan.cpl_eff>0? plan.cpl_eff : base.cpl);
    const effQ = (isFinite(fact.q) && fact.leads>0) ? fact.q : plan.q;
    const effCR = (isFinite(fact.cr) && fact.tLeads>0) ? fact.cr : plan.cr;

    const eff = applySeason({cpl:effCPL,q:effQ,cr:effCR,maxLeads:plan.maxLeads}, monthKey);
    fore.q  = eff.q;
    fore.cr = eff.cr;

    if(eff.cpl>0){
      if(fore.leads>0) fore.budget = fore.leads*eff.cpl;
      else if(fore.budget>0) fore.leads = fore.budget/eff.cpl;
    }
    fore.tLeads = fore.leads*fore.q;
    fore.sales  = fore.tLeads*fore.cr;
    fore.cpl = fore.leads>0 ? fore.budget/fore.leads : NaN;
    fore.cql = fore.tLeads>0 ? fore.budget/fore.tLeads : NaN;
    fore.cps = fore.sales>0 ? fore.budget/fore.sales : NaN;

    const availLeads = Math.max(0, plan.maxLeads - fact.leads);

    return {key:gr.key, name:GROUPS.find(x=>x.key===gr.key).name, base, plan, fact, fore, availLeads};
  });

  const tot = ["plan","fact","fore"].reduce((acc, k)=>{
    acc[k] = {budget:0,leads:0,tLeads:0,sales:0};
    per.forEach(x=>{
      acc[k].budget += n(x[k].budget);
      acc[k].leads  += n(x[k].leads);
      acc[k].tLeads += n(x[k].tLeads);
      acc[k].sales  += n(x[k].sales);
    });
    acc[k].q = acc[k].leads>0 ? acc[k].tLeads/acc[k].leads : NaN;
    acc[k].cpl = acc[k].leads>0 ? acc[k].budget/acc[k].leads : NaN;
    acc[k].cql = acc[k].tLeads>0 ? acc[k].budget/acc[k].tLeads : NaN;
    acc[k].cr  = acc[k].tLeads>0 ? acc[k].sales/acc[k].tLeads : NaN;
    acc[k].cps = acc[k].sales>0 ? acc[k].budget/acc[k].sales : NaN;
    return acc;
  }, {});
  return {month, per, tot, used};
}

function diagnoseBottleneck(mk){
  const {tot, used} = computeMonth(mk);
  const p=tot.plan, f=tot.fact;
  if(used<=0 || f.leads<=0) return "–ù–µ–º–∞ —Ñ–∞–∫—Ç—É ‚Üí –≤–Ω–µ—Å–∏ —Ç–∏–∂–¥–µ–Ω—å";

  const cplUp = (isFinite(p.cpl) && p.cpl>0 && isFinite(f.cpl) && f.cpl>0) ? (f.cpl/p.cpl) : 1;
  const qDown = (isFinite(p.q) && p.q>0 && isFinite(f.q) && f.q>0) ? (p.q/f.q) : 1;
  const crDown = (isFinite(p.cr) && p.cr>0 && isFinite(f.cr) && f.cr>0) ? (p.cr/f.cr) : 1;

  const max=Math.max(cplUp,qDown,crDown);
  if(max===cplUp) return "CPL (–¥–æ—Ä–æ–≥—ñ –ª—ñ–¥–∏) ‚Äî –∫—Ä–µ–∞—Ç–∏–≤/–∞—É–¥–∏—Ç–æ—Ä—ñ—ó/—Å—Ç—Ä—É–∫—Ç—É—Ä–∞";
  if(max===qDown) return "–Ø–∫—ñ—Å—Ç—å ‚Äî –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—è/–≤—ñ–¥—Å—ñ–≤/–æ—Ñ–µ—Ä";
  return "CR —É –ø—Ä–æ–¥–∞–∂ ‚Äî –ø—Ä–æ–¥–∞–∂—ñ/—Å–∫—Ä–∏–ø—Ç/—à–≤–∏–¥–∫—ñ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–æ–ª—å";
}

/* =========================================================
   5) OPTIMIZERS
========================================================= */
function oldOptimizerPlan(monthKey){
  const month=state.months[monthKey];
  const mk=monthKey;

  const targetKPI = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
  const budgetCap = n(month.planBudget);
  const budgetConstraint = budgetCap>0;

  const cand = month.groups.map(gr=>{
    const base = applySeason(BASE_MODEL[gr.key], mk);
    const eff = applySeason({
      cpl: n(gr.planCPL || base.cpl),
      q: n(gr.planQ),
      cr: n(gr.planCR),
      maxLeads: n(gr.maxLeads ?? base.maxLeads),
    }, mk);
    const kpiPerLead = (month.kpiMode==="sales") ? (eff.q*eff.cr) : eff.q;
    const costPerKPI = (eff.cpl>0) ? (eff.cpl / Math.max(0.001, kpiPerLead)) : 0;
    return {key:gr.key, eff, kpiPerLead, costPerKPI};
  }).sort((a,b)=>a.costPerKPI-b.costPerKPI);

  const add = {};
  month.groups.forEach(g=>add[g.key]={budget:0,leads:0,kpi:0});
  let need=targetKPI;
  let spent=0;
  let guard=0;

  while(need>0 && guard<200000){
    guard++;
    const pick = cand.find(c=>{
      const a=add[c.key];
      const avail = Math.max(0, c.eff.maxLeads - a.leads);
      if(avail<=0) return false;
      if(budgetConstraint && c.eff.cpl>0 && (spent + c.eff.cpl) > budgetCap) return false;
      return c.kpiPerLead>0;
    });
    if(!pick) break;

    const a=add[pick.key];
    const avail = Math.max(0, pick.eff.maxLeads - a.leads);
    const pack = Math.min(5, avail);
    a.leads += pack;
    const b = (pick.eff.cpl>0) ? pack*pick.eff.cpl : 0;
    a.budget += b;
    spent += b;
    const got = pack*pick.kpiPerLead;
    a.kpi += got;
    need -= got;
  }

  const total = Object.values(add).reduce((acc,x)=>{acc.budget+=x.budget; acc.leads+=x.leads; acc.kpi+=x.kpi; return acc;},{budget:0,leads:0,kpi:0});
  return {add, total, needLeft:need, spent, budgetCap, targetKPI};
}

function blendWeights(mode){
  if(mode==="70_30") return {fact:0.7, base:0.3};
  if(mode==="50_50") return {fact:0.5, base:0.5};
  if(mode==="90_10") return {fact:0.9, base:0.1};
  if(mode==="base_only") return {fact:0.0, base:1.0};
  if(mode==="fact_only") return {fact:1.0, base:0.0};
  return {fact:0.7, base:0.3};
}

function newOptimizerPlan(monthKey, baseMonthKey, blendMode){
  const month=state.months[monthKey];
  const mk=monthKey;

  const targetKPI = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
  const budgetCap = n(month.planBudget);
  const budgetConstraint = budgetCap>0;

  const w = blendWeights(blendMode);

  const baseCompute = computeMonth(baseMonthKey);
  const basePerfByKey = new Map(baseCompute.per.map(p=>{
    const kpiCost = (baseCompute.month.kpiMode==="sales") ? p.fact.cps : p.fact.cql;
    const kpiPerLead = (baseCompute.month.kpiMode==="sales")
      ? (p.fact.q * (isFinite(p.fact.cr)?p.fact.cr: (p.plan.cr||0)))
      : (p.fact.q);
    return [p.key, { factCPL:p.fact.cpl, factQ:p.fact.q, factCR:p.fact.cr, factKpiCost:kpiCost, factKpiPerLead:kpiPerLead }];
  }));

  const cand = month.groups.map(gr=>{
    const base = applySeason(BASE_MODEL[gr.key], mk);
    const baseEff = applySeason({
      cpl: n(gr.planCPL || base.cpl),
      q: n(gr.planQ),
      cr: n(gr.planCR),
      maxLeads: n(gr.maxLeads ?? base.maxLeads)
    }, mk);

    const perf = basePerfByKey.get(gr.key) || {};
    const factCPL = (isFinite(perf.factCPL) && perf.factCPL>0) ? perf.factCPL : baseEff.cpl;
    const factQ   = (isFinite(perf.factQ)   && perf.factQ>0)   ? perf.factQ   : baseEff.q;
    const factCR  = (isFinite(perf.factCR)  && perf.factCR>0)  ? perf.factCR  : baseEff.cr;

    const factEff = applySeason({cpl:factCPL,q:factQ,cr:factCR,maxLeads:baseEff.maxLeads}, mk);

    const blended = {
      cpl: factEff.cpl*w.fact + baseEff.cpl*w.base,
      q:   factEff.q*w.fact   + baseEff.q*w.base,
      cr:  factEff.cr*w.fact  + baseEff.cr*w.base,
      maxLeads: baseEff.maxLeads
    };

    const kpiPerLead = (month.kpiMode==="sales") ? (blended.q*blended.cr) : blended.q;
    const costPerKPI = (blended.cpl>0) ? (blended.cpl / Math.max(0.001, kpiPerLead)) : 0;

    return {key:gr.key, blended, kpiPerLead, costPerKPI};
  }).sort((a,b)=>a.costPerKPI-b.costPerKPI);

  const add = {};
  month.groups.forEach(g=>add[g.key]={budget:0,leads:0,kpi:0});
  let need=targetKPI;
  let spent=0;
  let guard=0;

  while(need>0 && guard<200000){
    guard++;
    const pick = cand.find(c=>{
      const a=add[c.key];
      const avail=Math.max(0, c.blended.maxLeads - a.leads);
      if(avail<=0) return false;
      if(budgetConstraint && c.blended.cpl>0 && (spent + c.blended.cpl) > budgetCap) return false;
      return c.kpiPerLead>0;
    });
    if(!pick) break;

    const a=add[pick.key];
    const avail=Math.max(0, pick.blended.maxLeads - a.leads);
    const pack=Math.min(5, avail);
    a.leads += pack;
    const b=(pick.blended.cpl>0)? pack*pick.blended.cpl : 0;
    a.budget += b;
    spent += b;
    const got=pack*pick.kpiPerLead;
    a.kpi += got;
    need -= got;
  }

  const total = Object.values(add).reduce((acc,x)=>{acc.budget+=x.budget; acc.leads+=x.leads; acc.kpi+=x.kpi; return acc;},{budget:0,leads:0,kpi:0});
  return {add, total, needLeft:need, spent, budgetCap, targetKPI, cand};
}

function applyPlanToMonth(planObj){
  const month=getMonth();
  Object.entries(planObj.add).forEach(([k,v])=>{
    const g=month.groups.find(x=>x.key===k);
    if(!g) return;
    g.planLeads = Math.max(0, n(v.leads));
    g.planBudget = Math.max(0, n(v.budget));
    g.planCPL = (g.planLeads>0) ? (g.planBudget/g.planLeads) : Math.max(0,n(g.planCPL));
  });
  if(n(month.planBudget)<=0){
    month.planBudget = Math.round(month.groups.reduce((a,x)=>a+n(x.planBudget),0));
  }
}

/* =========================================================
   6) WEEKLY FIX
========================================================= */
function weeklyFix(){
  const mk=state.activeMonth;
  const {month, tot, used} = computeMonth(mk);
  const W=n(month.weeksInMonth);
  const remainWeeks = Math.max(0, W-used);
  if(remainWeeks<=0){
    return {ok:false, msg:"–ú—ñ—Å—è—Ü—å —É–∂–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —Ñ–∞–∫—Ç–æ–º –ø–æ —Ç–∏–∂–Ω—è—Ö. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –º—ñ—Å—è—Ü—å.", patch:null};
  }

  const target = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
  const done = (month.kpiMode==="sales") ? tot.fact.sales : tot.fact.tLeads;
  const need = Math.max(0, target - done);

  if(need<=0){
    return {ok:true, msg:"KPI –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–∏–π —Ñ–∞–∫—Ç–æ–º. –ù–µ —Ç—Ä–µ–±–∞ –¥–æ–±–∏–≤–∞—Ç–∏ –±—é–¥–∂–µ—Ç–æ–º. –ó–∞—Ñ—ñ–∫—Å—É–π —è–∫—ñ—Å—Ç—å —ñ CR.", patch:null};
  }

  const bottle = diagnoseBottleneck(mk);
  if(bottle.startsWith("CR")){
    return {
      ok:true,
      msg:`–ì–æ–ª–æ–≤–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: <b>${bottle}</b>.<br><br>
      –ë—é–¥–∂–µ—Ç –∑–∞—Ä–∞–∑ ‚Äî –Ω–µ —Ä—ñ—à–µ–Ω–Ω—è. –ü–æ—Ç—Ä—ñ–±–Ω–æ: (1) —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚â§5 —Ö–≤, (2) —Å–∫—Ä–∏–ø—Ç –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó, (3) –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–∑–≤—ñ–Ω–∫—ñ–≤, (4) –æ—Ñ–µ—Ä/–≥–∞—Ä–∞–Ω—Ç—ñ—ó, (5) –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ follow-up.<br><br>
      –Ø –¥–∞–º –±—é–¥–∂–µ—Ç–Ω—ñ –ø—Ä–∞–≤–∫–∏ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ CR –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è.`,
      patch:null
    };
  }

  const monthObj = getMonth();
  const add = {};
  monthObj.groups.forEach(g=>add[g.key]={addLeads:0, addBudget:0, addKPI:0});

  const scored = monthObj.groups.map(gr=>{
    const f = sumFactForGroup(gr, used);
    const effCPL = (isFinite(f.cpl) && f.cpl>0) ? f.cpl : (n(gr.planCPL)>0 ? n(gr.planCPL) : applySeason(BASE_MODEL[gr.key], mk).cpl);
    const effQ = (isFinite(f.q) && f.leads>0) ? f.q : n(gr.planQ);
    const effCR = (isFinite(f.cr) && f.tLeads>0) ? f.cr : n(gr.planCR);
    const kpiPerLead = (monthObj.kpiMode==="sales") ? (effQ*effCR) : effQ;
    const costPerKPI = (effCPL>0) ? (effCPL / Math.max(0.001,kpiPerLead)) : 0;
    const maxLeads = Math.max(0, n(gr.maxLeads));
    const availLeads = Math.max(0, maxLeads - f.leads);
    return {key:gr.key, effCPL, effQ, effCR, kpiPerLead, costPerKPI, availLeads};
  }).sort((a,b)=>a.costPerKPI-b.costPerKPI);

  const budgetLeft = Math.max(0, n(monthObj.planBudget) - tot.fact.budget);
  const budgetConstraint = n(monthObj.planBudget)>0;

  let needLeft = need;
  let spent=0;
  let guard=0;

  while(needLeft>0 && guard<200000){
    guard++;
    const cand = scored.find(p=>{
      const a=add[p.key];
      if((p.availLeads - a.addLeads)<=0) return false;
      if(budgetConstraint && p.effCPL>0 && (spent + p.effCPL) > budgetLeft) return false;
      return p.kpiPerLead>0;
    });
    if(!cand) break;

    const a=add[cand.key];
    const pack = Math.min(5, cand.availLeads - a.addLeads);
    a.addLeads += pack;
    const b = (cand.effCPL>0)? pack*cand.effCPL : 0;
    a.addBudget += b;
    spent += b;
    const got = pack*cand.kpiPerLead;
    a.addKPI += got;
    needLeft -= got;
  }

  const sum = Object.values(add).reduce((acc,x)=>{acc.leads+=x.addLeads; acc.budget+=x.addBudget; acc.kpi+=x.addKPI; return acc;},{leads:0,budget:0,kpi:0});
  const kpiName = (monthObj.kpiMode==="sales") ? "–ø—Ä–æ–¥–∞–∂—ñ–≤" : "—Ü—ñ–ª—å–æ–≤–∏—Ö";

  let msg = `–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–±—Ä–∞—Ç–∏ <b>${fmt.num(need,2)}</b> ${kpiName} –¥–æ –∫—ñ–Ω—Ü—è –º—ñ—Å—è—Ü—è.<br>
  –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–æ–¥–∞—Ç–∏ ‚âà <b>${fmt.int(sum.leads)} –ª—ñ–¥—ñ–≤</b> —Ç–∞ ‚âà <b>${fmt.uah(sum.budget)}</b> (–ø–æ –Ω–∞–π–∫—Ä–∞—â–∏—Ö –∫–∞–Ω–∞–ª–∞—Ö).`;

  if(budgetConstraint && spent>=budgetLeft*0.99){
    msg += `<br><br><b>–û–±–º–µ–∂–µ–Ω–Ω—è –±—é–¥–∂–µ—Ç—É:</b> –∑–∞–ª–∏—à–æ–∫ ‚âà ${fmt.uah(budgetLeft)}. –Ø–∫—â–æ KPI –∫—Ä–∏—Ç–∏—á–Ω–∏–π ‚Äî –∞–±–æ –ø—ñ–¥–Ω—ñ–º–∞–π –±—é–¥–∂–µ—Ç, –∞–±–æ –ø—ñ–¥–Ω—ñ–º–∞–π Quality/CR.`;
  }
  if(sum.kpi < need*0.85){
    msg += `<br><br><b>–ß–µ—Å–Ω–æ:</b> –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—É –∫–∞–Ω–∞–ª—ñ–≤ –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î. –í–∞—Ä—ñ–∞–Ω—Ç–∏: (1) –ø—ñ–¥–Ω—è—Ç–∏ Quality, (2) –ø—ñ–¥–Ω—è—Ç–∏ CR, (3) –¥–æ–¥–∞—Ç–∏ –¥–∂–µ—Ä–µ–ª–∞, (4) –∑–±—ñ–ª—å—à–∏—Ç–∏ –±—é–¥–∂–µ—Ç.`;
  }

  return {ok:true, msg, add, bottle};
}

function applyWeeklyFix(fix){
  if(!fix || !fix.add) return false;
  const month=getMonth();
  Object.entries(fix.add).forEach(([k,v])=>{
    const g = month.groups.find(x=>x.key===k);
    if(!g) return;
    g.planLeads  = n(g.planLeads) + n(v.addLeads);
    g.planBudget = n(g.planBudget) + n(v.addBudget);
    g.planCPL = (g.planLeads>0) ? (g.planBudget/g.planLeads) : g.planCPL;
  });
  return true;
}

/* =========================================================
   7) SHEET
========================================================= */
const COLS = [
  {k:"planBudget", t:"–ë—é–¥–∂–µ—Ç –ü–õ–ê–ù", type:"uah"},
  {k:"planLeads",  t:"–õ—ñ–¥–∏ –ü–õ–ê–ù", type:"int"},
  {k:"planCPL",    t:"CPL –ü–õ–ê–ù (–≥—Ä–Ω)", type:"uah"},
  {k:"planQ",      t:"–Ø–∫—ñ—Å—Ç—å –ü–õ–ê–ù %", type:"pct"},
  {k:"planCR",     t:"CR –ü–õ–ê–ù %", type:"pct"},
  {k:"maxLeads",   t:"–õ—ñ–º—ñ—Ç –ª—ñ–¥—ñ–≤/–º—ñ—Å", type:"int"},
  {k:"w_budget",   t:"–ë—é–¥–∂–µ—Ç –§–ê–ö–¢ (—Ç–∏–∂–¥–µ–Ω—å)", type:"uah"},
  {k:"w_leads",    t:"–õ—ñ–¥–∏ –§–ê–ö–¢ (—Ç–∏–∂–¥–µ–Ω—å)", type:"int"},
  {k:"w_q",        t:"–Ø–∫—ñ—Å—Ç—å –§–ê–ö–¢ %", type:"pct"},
  {k:"w_sales",    t:"–ü—Ä–æ–¥–∞–∂—ñ –§–ê–ö–¢ (—Ç–∏–∂–¥–µ–Ω—å)", type:"int"},
];

function currentWeekIndex(){
  const w = n(document.getElementById("weekSel").value || 0);
  return clamp(w, 0, 4);
}

function buildSheet(){
  const month=getMonth();
  const table=document.getElementById("sheet");
  table.innerHTML="";

  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  const th0=document.createElement("th"); th0.textContent="–ö–∞–Ω–∞–ª"; trh.appendChild(th0);
  COLS.forEach(c=>{ const th=document.createElement("th"); th.textContent=c.t; trh.appendChild(th); });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  month.groups.forEach((gr, rIdx)=>{
    const tr=document.createElement("tr");
    const tdName=document.createElement("td");
    tdName.textContent = GROUPS.find(x=>x.key===gr.key).name;
    tr.appendChild(tdName);

    COLS.forEach((c, cIdx)=>{
      const td=document.createElement("td");
      const inp=document.createElement("input");
      inp.className="cell num";
      inp.dataset.r=rIdx; inp.dataset.c=cIdx; inp.dataset.k=c.k;
      inp.placeholder="0";
      inp.onfocus=()=>{try{inp.select()}catch(e){}};
      inp.oninput=debounce(()=>{ if(!isEditUnlocked()) return; writeCell(inp); markDirty(); },120);
      inp.onkeydown=(e)=>nav(e, inp);

      inp.onpaste=(e)=>{
        if(!state.pasteHot) return;
        if(!isEditUnlocked()) return;
        const text=(e.clipboardData||window.clipboardData).getData("text");
        if(!text || (!text.includes("\t") && !text.includes("\n"))) return;
        e.preventDefault();
        pasteGrid(text, n(inp.dataset.r), n(inp.dataset.c));
        toast("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω–æ –∑ —Ç–∞–±–ª–∏—Ü—ñ. –ü–µ—Ä–µ–≤—ñ—Ä –∑–Ω–∞—á–µ–Ω–Ω—è.");
      };

      td.appendChild(inp);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  refreshSheetValues();
}

function refreshSheetValues(){
  const month=getMonth();
  const w=currentWeekIndex();
  document.querySelectorAll("#sheet .cell").forEach(inp=>{
    const r=n(inp.dataset.r), c=n(inp.dataset.c);
    const col=COLS[c];
    const gr=month.groups[r];
    let v=0;
    if(col.k==="planBudget") v=gr.planBudget;
    else if(col.k==="planLeads") v=gr.planLeads;
    else if(col.k==="planCPL") v=gr.planCPL;
    else if(col.k==="planQ") v=Math.round(gr.planQ*10000)/100;
    else if(col.k==="planCR") v=Math.round(gr.planCR*10000)/100;
    else if(col.k==="maxLeads") v=gr.maxLeads;
    else if(col.k==="w_budget") v=gr.weeks[w].budget;
    else if(col.k==="w_leads") v=gr.weeks[w].leads;
    else if(col.k==="w_q") v=Math.round(gr.weeks[w].q*10000)/100;
    else if(col.k==="w_sales") v=gr.weeks[w].sales;
    inp.value = (v===0 ? "" : v);
  });
}

function writeCell(inp){
  const month=getMonth();
  const r=n(inp.dataset.r), c=n(inp.dataset.c);
  const col=COLS[c];
  const gr=month.groups[r];
  const raw=(inp.value||"").toString().replace(",",".").trim();
  const val = raw==="" ? 0 : n(raw);
  const w=currentWeekIndex();

  switch(col.k){
    case "planBudget": gr.planBudget=Math.max(0,val); break;
    case "planLeads":  gr.planLeads=Math.max(0,val); break;
    case "planCPL":    gr.planCPL=Math.max(0,val); break;
    case "planQ":      gr.planQ=clamp(val/100,0,1); break;
    case "planCR":     gr.planCR=clamp(val/100,0,1); break;
    case "maxLeads":   gr.maxLeads=Math.max(0,val); break;
    case "w_budget":   gr.weeks[w].budget=Math.max(0,val); break;
    case "w_leads":    gr.weeks[w].leads=Math.max(0,val); break;
    case "w_q":        gr.weeks[w].q=clamp(val/100,0,1); break;
    case "w_sales":    gr.weeks[w].sales=Math.max(0,val); break;
  }
}

function nav(e, inp){
  const r=n(inp.dataset.r), c=n(inp.dataset.c);
  let nr=r, nc=c;
  const key=e.key;
  if(key==="Enter"){ e.preventDefault(); nr=r+1; }
  else if(key==="ArrowDown"){ e.preventDefault(); nr=r+1; }
  else if(key==="ArrowUp"){ e.preventDefault(); nr=r-1; }
  else if(key==="ArrowRight"){ if(inp.selectionStart===inp.value.length){ e.preventDefault(); nc=c+1; } }
  else if(key==="ArrowLeft"){ if(inp.selectionStart===0){ e.preventDefault(); nc=c-1; } }
  else return;

  nr=clamp(nr,0,GROUPS.length-1);
  nc=clamp(nc,0,COLS.length-1);
  const next=document.querySelector(`#sheet .cell[data-r="${nr}"][data-c="${nc}"]`);
  if(next) next.focus();
}

function pasteGrid(text, startR, startC){
  const month=getMonth();
  const rows=text.replace(/\r/g,"").split("\n").filter(x=>x.length>0);
  const grid=rows.map(r=>r.split("\t"));
  for(let i=0;i<grid.length;i++){
    for(let j=0;j<grid[i].length;j++){
      const r=startR+i, c=startC+j;
      if(r>=month.groups.length || c>=COLS.length) continue;
      const inp=document.querySelector(`#sheet .cell[data-r="${r}"][data-c="${c}"]`);
      if(!inp) continue;
      inp.value=grid[i][j];
      writeCell(inp);
    }
  }
  refreshSheetValues();
  markDirty();
}

/* =========================================================
   8) CHARTS
========================================================= */
function clearCanvas(ctx){
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.globalAlpha=.10; ctx.strokeStyle="white";
  for(let x=0;x<w;x+=70){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  for(let y=0;y<h;y+=55){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if(w<2*r) r=w/2; if(h<2*r) r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function drawLegend(ctx, items){
  ctx.save();
  ctx.font="12px var(--sans)";
  let x=70, y=36;
  items.forEach(it=>{
    ctx.fillStyle=it.color; ctx.fillRect(x,y-10,12,12);
    ctx.fillStyle="rgba(232,238,247,.92)";
    ctx.fillText(it.label, x+18, y);
    x += 18 + ctx.measureText(it.label).width + 18;
  });
  ctx.restore();
}

function drawGroupedBars(ctx, labels, series, yLabel, title){
  clearCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;
  const pad={l:74,r:22,t:34,b:52};
  const innerW=w-pad.l-pad.r, innerH=h-pad.t-pad.b;

  let mx=1;
  series.forEach(s=>s.data.forEach(v=>{ if(isFinite(v)) mx=Math.max(mx, v); }));

  ctx.save();
  ctx.fillStyle="rgba(232,238,247,.95)";
  ctx.font="1000 14px var(--sans)";
  ctx.fillText(title, pad.l, 20);
  ctx.fillStyle="rgba(157,176,200,.88)";
  ctx.font="12px var(--sans)";
  ctx.fillText("X: –ø–µ—Ä—ñ–æ–¥", pad.l, h-10);
  ctx.translate(16, pad.t + innerH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Y: "+yLabel, 0, 0);
  ctx.restore();

  ctx.save();
  ctx.strokeStyle="rgba(255,255,255,.12)";
  ctx.fillStyle="rgba(157,176,200,.88)";
  ctx.font="11px var(--sans)";
  const ticks=4;
  for(let i=0;i<=ticks;i++){
    const y=pad.t + innerH - (innerH*i/ticks);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+innerW, y); ctx.stroke();
    const v = mx*(i/ticks);
    ctx.fillText(Math.round(v).toLocaleString("uk-UA"), 8, y+3);
  }
  ctx.restore();

  const groups=labels.length, bars=series.length;
  const groupW=innerW/groups;
  const barW=Math.min(46, (groupW-18)/bars);
  const gap=6;

  for(let gi=0;gi<groups;gi++){
    const gx=pad.l + gi*groupW;

    ctx.save();
    ctx.fillStyle="rgba(157,176,200,.88)";
    ctx.font="12px var(--sans)";
    const lab=labels[gi];
    ctx.fillText(lab, gx+groupW/2-ctx.measureText(lab).width/2, pad.t+innerH+26);
    ctx.restore();

    for(let bi=0;bi<bars;bi++){
      const s=series[bi];
      const v=s.data[gi];
      if(!isFinite(v) || v<0) continue;
      const bh = innerH*(v/mx);
      const x = gx+9 + bi*(barW+gap);
      const y = pad.t + innerH - bh;

      ctx.save();
      ctx.fillStyle=s.color;
      ctx.strokeStyle="rgba(255,255,255,.16)";
      roundRect(ctx, x, y, barW, bh, 10, true, true);

      ctx.fillStyle="rgba(232,238,247,.95)";
      ctx.font="11px var(--sans)";
      const txt=(v>=1000)? Math.round(v).toLocaleString("uk-UA") : (Math.round(v*10)/10).toString();
      ctx.fillText(txt, x, y-6);
      ctx.restore();
    }
  }
  drawLegend(ctx, series.map(s=>({label:s.label,color:s.color})));
}

function drawFunnel(ctx, plan, fact, fore, title){
  clearCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;

  ctx.save();
  ctx.fillStyle="rgba(232,238,247,.95)";
  ctx.font="1000 14px var(--sans)";
  ctx.fillText(title, 74, 20);
  ctx.restore();

  const pad={l:74,r:22,t:44,b:38};
  const innerW=w-pad.l-pad.r, innerH=h-pad.t-pad.b;

  const stages=["–õ—ñ–¥–∏","–¶—ñ–ª—å–æ–≤—ñ","–ü—Ä–æ–¥–∞–∂—ñ"];
  const P=[plan.leads, plan.tLeads, plan.sales];
  const F=[fact.leads, fact.tLeads, fact.sales];
  const R=[fore.leads, fore.tLeads, fore.sales];

  const mx=Math.max(1, ...P, ...F, ...R);

  const colW=innerW/3;
  const colors=["rgba(107,183,184,.85)","rgba(255,204,102,.78)","rgba(255,107,122,.78)"];

  for(let i=0;i<3;i++){
    const x0=pad.l + i*colW;
    const stage=stages[i];

    ctx.save();
    ctx.fillStyle="rgba(157,176,200,.88)";
    ctx.font="12px var(--sans)";
    ctx.fillText(stage, x0+colW/2-ctx.measureText(stage).width/2, 36);
    ctx.restore();

    const arr=[P[i],F[i],R[i]];
    const barW=Math.min(52, (colW-26)/3);
    const gap=8;
    const baseY=pad.t+innerH;

    ["–ü–ª–∞–Ω","–§–∞–∫—Ç","–ü—Ä–æ–≥–Ω–æ–∑"].forEach((lab,bi)=>{
      const v=arr[bi];
      const bh=innerH*(v/mx);
      const x=x0+13+bi*(barW+gap);
      const y=baseY-bh;

      ctx.save();
      ctx.fillStyle=colors[i];
      ctx.globalAlpha = bi===0?0.55:(bi===1?0.85:0.70);
      ctx.strokeStyle="rgba(255,255,255,.16)";
      roundRect(ctx,x,y,barW,bh,10,true,true);
      ctx.globalAlpha=1;
      ctx.fillStyle="rgba(232,238,247,.95)";
      ctx.font="11px var(--sans)";
      ctx.fillText((Math.round(v*10)/10).toLocaleString("uk-UA"), x, y-6);
      ctx.restore();
    });
  }

  const eff = [
    {label:"CPL", v:fore.cpl},
    {label:"CQL", v:fore.cql},
    {label:"CPS", v:fore.cps},
    {label:"Q",   v:fore.q, pct:true},
    {label:"CR",  v:fore.cr, pct:true},
  ];

  let x=74, y=h-12;
  ctx.save();
  ctx.font="12px var(--sans)";
  eff.forEach(e=>{
    const txt = e.pct ? `${e.label}: ${fmt.pct01(e.v)}` : `${e.label}: ${fmt.uah(e.v)}`;
    ctx.fillStyle="rgba(157,176,200,.9)";
    ctx.fillText(txt, x, y);
    x += ctx.measureText(txt).width + 18;
  });
  ctx.restore();
}

function drawChannelsChart(ctx, per, mode, title){
  const labels=per.map(p=>p.name.replace(" (Search/PMax/YT)",""));
  const kpi = per.map(p=>{
    if(mode==="sales") return p.fore.sales;
    return p.fore.tLeads;
  });
  const budget = per.map(p=>p.fore.budget);
  drawGroupedBars(ctx, labels, [
    {label:mode==="sales"?"KPI (–ø—Ä–æ–¥–∞–∂—ñ)":"KPI (—Ü—ñ–ª—å–æ–≤—ñ)", color:"rgba(255,204,102,.78)", data:kpi},
    {label:"–ë—é–¥–∂–µ—Ç", color:"rgba(107,183,184,.85)", data:budget},
  ], "–æ–±—Å—è–≥", title);
}

function historySeries(){
  const keys = state.historyOrder.filter(k=>state.months[k]);
  const labels=[], kpiPlan=[], kpiFact=[], bPlan=[], bFact=[];
  keys.forEach(k=>{
    const {month, tot} = computeMonth(k);
    labels.push(k.slice(5));
    const kp = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
    const kf = (month.kpiMode==="sales") ? tot.fact.sales : tot.fact.tLeads;
    kpiPlan.push(kp);
    kpiFact.push(kf);
    bPlan.push(n(month.planBudget));
    bFact.push(tot.fact.budget);
  });
  return {labels, kpiPlan, kpiFact, bPlan, bFact};
}

/* =========================================================
   9) DASH
========================================================= */
function kpiCard(title, value, sub, tone=""){
  const div=document.createElement("div");
  div.className="k"+(tone?(" "+tone):"");
  div.innerHTML=`<div class="t">${title}</div><div class="v">${value}</div><div class="s">${sub}</div>`;
  return div;
}

function renderDash(){
  const mk=state.activeMonth;
  const {month, tot, used, per}=computeMonth(mk);
  document.getElementById("monthPill").textContent = monthLabel(mk);

  const W=n(month.weeksInMonth);
  const expected = used>0 ? (used/W) : 0.01;
  const target = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
  const done = (month.kpiMode==="sales") ? tot.fact.sales : tot.fact.tLeads;
  const progress = target>0 ? (done/target) : 0;
  const tone = (progress < expected*0.85) ? "bad" : (progress < expected*1.05 ? "warn" : "good");

  const kpisEl=document.getElementById("kpis");
  kpisEl.innerHTML="";
  const kpiName = month.kpiMode==="sales" ? "–ü—Ä–æ–¥–∞–∂—ñ" : "–¶—ñ–ª—å–æ–≤—ñ";
  kpisEl.appendChild(kpiCard(`–ü–ª–∞–Ω –º—ñ—Å—è—Ü—è ‚Ä¢ ${kpiName}`, month.kpiMode==="sales"? fmt.int(month.planSales) : fmt.int(month.planTLeads), "–¶—ñ–ª—å KPI"));
  kpisEl.appendChild(kpiCard("–§–∞–∫—Ç –∑–∞—Ä–∞–∑ ‚Ä¢ KPI", fmt.num(done,2), `–¢–∏–∂–Ω—ñ–≤ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ: ${used}/${W}`, tone));
  kpisEl.appendChild(kpiCard("–ü—Ä–æ–≥–Ω–æ–∑ –¥–æ –∫—ñ–Ω—Ü—è ‚Ä¢ KPI", fmt.num(month.kpiMode==="sales"? tot.fore.sales : tot.fore.tLeads,2), "Run-rate + —Å–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å", tone));
  kpisEl.appendChild(kpiCard("–ë—é–¥–∂–µ—Ç ‚Ä¢ –ü–ª–∞–Ω / –§–∞–∫—Ç", `${fmt.uah(month.planBudget)} / ${fmt.uah(tot.fact.budget)}`, "–ö–æ–Ω—Ç—Ä–æ–ª—å –≤–∏—Ç—Ä–∞—Ç", tone));
  kpisEl.appendChild(kpiCard("CPL (–ø—Ä–æ–≥–Ω–æ–∑)", fmt.uah(tot.fore.cpl), "–¶—ñ–Ω–∞ –ª—ñ–¥–∞", tone));
  kpisEl.appendChild(kpiCard("CQL (–ø—Ä–æ–≥–Ω–æ–∑)", fmt.uah(tot.fore.cql), "–¶—ñ–Ω–∞ —Ü—ñ–ª—å–æ–≤–æ–≥–æ", tone));
  kpisEl.appendChild(kpiCard("CPS (–ø—Ä–æ–≥–Ω–æ–∑)", fmt.uah(tot.fore.cps), "–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É", tone));
  kpisEl.appendChild(kpiCard("–Ø–∫—ñ—Å—Ç—å (—Ñ–∞–∫—Ç/–ø—Ä–æ–≥–Ω–æ–∑)", `${fmt.pct01(tot.fact.q)} / ${fmt.pct01(tot.fore.q)}`, "–¶—ñ–ª—å–æ–≤—ñ / –ª—ñ–¥–∏", tone));

  const pace=document.getElementById("paceBadge");
  pace.className="badge "+tone;
  pace.innerHTML=`–¢–µ–º–ø: <b>${Math.round(progress*100)}%</b> (–æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: ${Math.round(expected*100)}%)`;

  const bottle=document.getElementById("bottleBadge");
  const b = diagnoseBottleneck(mk);
  bottle.className="badge "+tone;
  bottle.innerHTML=`–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ: <b>${b}</b>`;

  const wb=document.getElementById("weekBadge");
  wb.className="badge";
  wb.innerHTML=`–¢–∏–∂–Ω—ñ: <b>${used}/${W}</b> ‚Ä¢ –§–∞–∫—Ç –±—é–¥–∂–µ—Ç: <b>${fmt.uah(tot.fact.budget)}</b>`;

  drawGroupedBars(
    document.getElementById("chartMain").getContext("2d"),
    ["–ü–ª–∞–Ω","–§–∞–∫—Ç","–ü—Ä–æ–≥–Ω–æ–∑"],
    [
      {label:`KPI (${month.kpiMode==="sales"?"–ü—Ä–æ–¥–∞–∂—ñ":"–¶—ñ–ª—å–æ–≤—ñ"})`, color:"rgba(255,204,102,.78)", data: month.kpiMode==="sales"
        ? [tot.plan.sales, tot.fact.sales, tot.fore.sales]
        : [tot.plan.tLeads, tot.fact.tLeads, tot.fore.tLeads]
      },
      {label:"–ë—é–¥–∂–µ—Ç", color:"rgba(107,183,184,.85)", data:[n(month.planBudget), tot.fact.budget, tot.fore.budget]},
    ],
    "–æ–±—Å—è–≥",
    "–ü–ª–∞–Ω / –§–∞–∫—Ç / –ü—Ä–æ–≥–Ω–æ–∑ (KPI + –ë—é–¥–∂–µ—Ç)"
  );

  drawFunnel(
    document.getElementById("chartFunnel").getContext("2d"),
    tot.plan, tot.fact, tot.fore,
    "–í–æ—Ä–æ–Ω–∫–∞ + –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å"
  );

  drawChannelsChart(
    document.getElementById("chartChannels").getContext("2d"),
    per,
    month.kpiMode,
    "–ö–∞–Ω–∞–ª–∏: –≤–Ω–µ—Å–æ–∫ —É KPI (–ø—Ä–æ–≥–Ω–æ–∑) + –±—é–¥–∂–µ—Ç"
  );

  const hs=historySeries();
  drawGroupedBars(
    document.getElementById("chartHistory").getContext("2d"),
    hs.labels,
    [
      {label:"KPI –ü–ª–∞–Ω", color:"rgba(107,183,184,.85)", data:hs.kpiPlan},
      {label:"KPI –§–∞–∫—Ç", color:"rgba(255,204,102,.78)", data:hs.kpiFact},
      {label:"–ë—é–¥–∂–µ—Ç –ü–ª–∞–Ω", color:"rgba(138,125,255,.75)", data:hs.bPlan},
      {label:"–ë—é–¥–∂–µ—Ç –§–∞–∫—Ç", color:"rgba(255,107,122,.70)", data:hs.bFact},
    ],
    "–∑–Ω–∞—á–µ–Ω–Ω—è",
    "–Ü—Å—Ç–æ—Ä—ñ—è: KPI —ñ –ë—é–¥–∂–µ—Ç (–º—ñ—Å—è—Ü—ñ)"
  );

  renderWeeklyConclusion(mk, tone);
}

function renderWeeklyConclusion(mk, tone){
  const {month, tot, used, per}=computeMonth(mk);
  const W=n(month.weeksInMonth);
  const expected = used>0 ? (used/W) : 0.01;

  const target = (month.kpiMode==="sales") ? n(month.planSales) : n(month.planTLeads);
  const done = (month.kpiMode==="sales") ? tot.fact.sales : tot.fact.tLeads;
  const progress = target>0 ? (done/target) : 0;

  const kpiName = month.kpiMode==="sales" ? "–ø—Ä–æ–¥–∞–∂—ñ" : "—Ü—ñ–ª—å–æ–≤—ñ –ª—ñ–¥–∏";
  const acts = [];

  if(used===0){
    acts.push("–°–ø–µ—Ä—à—É –≤–Ω–µ—Å–∏ —Ñ–∞–∫—Ç —Ö–æ—á–∞ –± –∑–∞ 1 —Ç–∏–∂–¥–µ–Ω—å. –ë–µ–∑ —Ü—å–æ–≥–æ –≤—Å—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ ‚Äî –¥–µ–∫–æ—Ä–∞—Ü—ñ—è.");
  } else {
    if(progress < expected*0.85){
      acts.push("–¢–∏ –≤—ñ–¥—Å—Ç–∞—î—à —Å–∏—Å—Ç–µ–º–Ω–æ. –†—ñ—à–µ–Ω–Ω—è: –∞–±–æ –ø—ñ–¥–Ω—è—Ç–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, –∞–±–æ –ø–µ—Ä–µ—Ä–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ –∑–∞–ª–∏—à–æ–∫ –º—ñ—Å—è—Ü—è.");
      acts.push("–ù–∞—Ç–∏—Å–Ω–∏: <b>–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ü—ñ—é</b>. –Ø–∫—â–æ —Ç–∞–º 'CR' ‚Äî –±—é–¥–∂–µ—Ç –Ω–µ –ª—ñ–∫—É—î.");
      acts.push("–ó—Ä–æ–±–∏ –¥—ñ–∞–≥–Ω–æ–∑: CPL / –Ø–∫—ñ—Å—Ç—å / CR ‚Äî —â–æ —Å–∞–º–µ –∑–ª–∞–º–∞–ª–æ—Å—å. –ë–µ–∑ –¥—ñ–∞–≥–Ω–æ–∑—É —Ç–∏ –ø—Ä–æ—Å—Ç–æ –ø–∞–ª–∏—à –≥—Ä–æ—à—ñ.");
    } else if(progress < expected*1.05){
      acts.push("–¢–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Ç–µ–º–ø—É. –ì–æ–ª–æ–≤–Ω–µ ‚Äî –Ω–µ –∑–ª–∞–º–∞—Ç–∏ —è–∫—ñ—Å—Ç—å –ø—ñ–¥ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è–º.");
      acts.push("–ü–ª–∞–Ω: +10‚Äì15% —É –Ω–∞–π—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à—ñ –∫–∞–Ω–∞–ª–∏, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ Quality –Ω–µ –ø–∞–¥–∞—î.");
    } else {
      acts.push("–¢–∏ –ø–æ–ø–µ—Ä–µ–¥—É —Ç–µ–º–ø—É. –ù–µ —Ä–æ–∑–¥—É–≤–∞–π –±—é–¥–∂–µ—Ç –±–µ–∑ –ø–æ—Ç—Ä–µ–±–∏. –§—ñ–∫—Å—É–π –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω—ñ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—É.");
      acts.push("–ó–∞–¥–∞—á–∞: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑—É–≤–∞—Ç–∏ (–∫—Ä–µ–∞—Ç–∏–≤–∏/—Å–∫—Ä–∏–ø—Ç/–∫–æ–Ω—Ç—Ä–æ–ª—å) ‚Äî —â–æ–± —Ç–µ–º–ø –Ω–µ –±—É–≤ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º.");
    }
  }

  const score = per.map(x=>{
    const cost = (month.kpiMode==="sales") ? x.fore.cps : x.fore.cql;
    return {name:x.name, cost};
  }).filter(x=>isFinite(x.cost)).sort((a,b)=>a.cost-b.cost).slice(0,3);
  if(score.length){
    acts.push(`–ù–∞–π–∫—Ä–∞—â—ñ –∫–∞–Ω–∞–ª–∏ –ø–æ —Ü—ñ–Ω—ñ KPI (–ø—Ä–æ–≥–Ω–æ–∑): <b>${score.map(s=>`${s.name} (${fmt.uah(s.cost)})`).join(", ")}</b>.`);
  }

  const b = diagnoseBottleneck(mk);
  let operational = "";
  if(b.startsWith("CPL")){
    operational = `
      <b>–§–æ–∫—É—Å —Ç–∏–∂–Ω—è:</b> CPL.<br>
      ‚Ä¢ 5‚Äì10 –Ω–æ–≤–∏—Ö –∫—Ä–µ–∞—Ç–∏–≤—ñ–≤/–≤–∞—Ä—ñ–∞—Ü—ñ–π –Ω–∞ –∫–ª—é—á–æ–≤—ñ –∫–∞–Ω–∞–ª–∏.<br>
      ‚Ä¢ –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤—Å–µ, —â–æ –¥–∞—î CPL > —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –Ω–∞ 30%.<br>
      ‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–º–ø–∞–Ω—ñ–π, –≥–µ–æ, –ø–ª–µ–π—Å–º–µ–Ω—Ç–∏, —á–∞—Å—Ç–æ—Ç—É, UTM/—Å–∞–π—Ç.`;
  } else if(b.startsWith("–Ø–∫—ñ—Å—Ç—å")){
    operational = `
      <b>–§–æ–∫—É—Å —Ç–∏–∂–Ω—è:</b> –Ø–∫—ñ—Å—Ç—å.<br>
      ‚Ä¢ –£—Ç–æ—á–Ω–∏—Ç–∏ –æ—Ñ–µ—Ä —ñ ‚Äú–≤—ñ–¥—Å—ñ–≤‚Äù (–ø–∏—Ç–∞–Ω–Ω—è —É —Ñ–æ—Ä–º—ñ, –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—è, —Ü—ñ–Ω–æ–≤–∏–π —è–∫–æ—Ä).<br>
      ‚Ä¢ –í—ñ–¥—Å—ñ–∫—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó, —è–∫—ñ –¥–∞—é—Ç—å ‚Äú–¥–µ—à–µ–≤–æ, –∞–ª–µ —Å–º—ñ—Ç—Ç—è‚Äù.<br>
      ‚Ä¢ –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç: —â–æ —Ç–∞–∫–µ ‚Äú—Ü—ñ–ª—å–æ–≤–∏–π –ª—ñ–¥‚Äù (1 —Å—Ç–æ—Ä—ñ–Ω–∫–∞).`;
  } else if(b.startsWith("CR")){
    operational = `
      <b>–§–æ–∫—É—Å —Ç–∏–∂–Ω—è:</b> –ü—Ä–æ–¥–∞–∂—ñ (CR).<br>
      ‚Ä¢ –®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚â§ 5 —Ö–≤ (–∫–æ–Ω—Ç—Ä–æ–ª—å).<br>
      ‚Ä¢ –°–∫—Ä–∏–ø—Ç –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó (5 –ø–∏—Ç–∞–Ω—å) + —á—ñ—Ç–∫—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏.<br>
      ‚Ä¢ 20 –∑–∞–ø–∏—Å–∞–Ω–∏—Ö –¥–∑–≤—ñ–Ω–∫—ñ–≤ –Ω–∞ —Ä–µ–≤‚Äô—é + –ø—Ä–∞–≤–∫–∏ –æ—Ñ–µ—Ä–∞/–∑–∞–ø–µ—Ä–µ—á–µ–Ω—å.`;
  } else {
    operational = `<b>–§–æ–∫—É—Å —Ç–∏–∂–Ω—è:</b> –≤–Ω–µ—Å–∏ —Ñ–∞–∫—Ç —ñ –∑—Ä–æ–±–∏ –∫–æ—Ä–µ–∫—Ü—ñ—é.`;
  }

  const box=document.getElementById("weeklyConclusionBox");
  box.innerHTML = `
    <b>–ü—ñ–¥—Å—É–º–æ–∫:</b> KPI <b>${kpiName}</b> –≤–∏–∫–æ–Ω–∞–Ω–æ –Ω–∞ <b>${Math.round(progress*100)}%</b>, –æ—á—ñ–∫—É–≤–∞–Ω–æ –Ω–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ <b>${Math.round(expected*100)}%</b>.<br><br>
    <b>–©–æ —Ä–æ–±–∏—Ç–∏:</b><br>
    ‚Ä¢ ${acts.join("<br>‚Ä¢ ")}<br><br>
    ${operational}
  `;
}

/* =========================================================
   10) SETTINGS TAB
========================================================= */
function renderSettings(){
  const mk=state.activeMonth;
  const box=document.getElementById("settingsBox");
  box.innerHTML="";

  const wrap=document.createElement("div");
  wrap.className="sheetWrap";

  const table=document.createElement("table");
  table.className="sheet";
  table.style.minWidth="980px";

  const cols=["–ö–∞–Ω–∞–ª","–õ—ñ–º—ñ—Ç –ª—ñ–¥—ñ–≤/–º—ñ—Å","CPL –±–∞–∑–æ–≤–∏–π","Quality –±–∞–∑–æ–≤–∞","CR –±–∞–∑–æ–≤–∏–π","–°–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å"];
  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  cols.forEach(t=>{const th=document.createElement("th"); th.textContent=t; trh.appendChild(th);});
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  GROUPS.forEach(g=>{
    const tr=document.createElement("tr");
    const base=BASE_MODEL[g.key];

    const td0=document.createElement("td"); td0.textContent=g.name; tr.appendChild(td0);
    const td1=document.createElement("td"); td1.style.padding="10px 10px"; td1.textContent=fmt.int(base.maxLeads); tr.appendChild(td1);
    const td2=document.createElement("td"); td2.style.padding="10px 10px"; td2.textContent=fmt.uah(base.cpl); tr.appendChild(td2);
    const td3=document.createElement("td"); td3.style.padding="10px 10px"; td3.textContent=Math.round(base.q*100)+"%"; tr.appendChild(td3);
    const td4=document.createElement("td"); td4.style.padding="10px 10px"; td4.textContent=Math.round(base.cr*100)+"%"; tr.appendChild(td4);

    const s=SEASON[mk]||{cpl:1,q:1,cr:1};
    const td5=document.createElement("td"); td5.style.padding="10px 10px";
    td5.innerHTML = `<span class="pill"><strong>CPL√ó${s.cpl.toFixed(2)}</strong><span class="muted">Q√ó${s.q.toFixed(2)} ‚Ä¢ CR√ó${s.cr.toFixed(2)}</span></span>`;
    tr.appendChild(td5);

    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);
  box.appendChild(wrap);

  const tip=document.createElement("div");
  tip.className="noteBox";
  tip.style.marginTop="10px";
  tip.innerHTML = `
    <b>–õ–æ–≥—ñ–∫–∞:</b><br>
    ‚Ä¢ CPL –∑–ª–µ—Ç—ñ–≤ ‚Üí –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (–∫—Ä–µ–∞—Ç–∏–≤/–∞—É–¥–∏—Ç–æ—Ä—ñ—ó/—Å—Ç—Ä—É–∫—Ç—É—Ä–∞).<br>
    ‚Ä¢ Quality –≤–ø–∞–≤ ‚Üí –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—è/–æ—Ñ–µ—Ä/–≤—ñ–¥—Å—ñ–≤.<br>
    ‚Ä¢ CR –≤–ø–∞–≤ ‚Üí –ø—Ä–æ–¥–∞–∂—ñ. –ë—é–¥–∂–µ—Ç —á–∞—Å—Ç–æ —à–∫–æ–¥–∏—Ç—å, –±–æ –º–Ω–æ–∂–∏—Ç—å —Ö–∞–æ—Å.<br><br>
    –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±–∞–∑–æ–≤–æ—ó –º–æ–¥–µ–ª—ñ —Ç—É—Ç –Ω–µ —Ä–æ–±–∏—Ç—å—Å—è (—â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—É). –ó–º—ñ–Ω—é–π –ø–ª–∞–Ω–æ–≤—ñ CPL/Q/CR —É –≤–∫–ª–∞–¥—Ü—ñ ‚Äú–í–≤—ñ–¥‚Äù.
  `;
  box.appendChild(tip);
}

/* =========================================================
   11) UI: tabs + selectors
========================================================= */
const TABS=[
  {id:"dash", label:"–î–∞—à–±–æ—Ä–¥"},
  {id:"input", label:"–í–≤—ñ–¥"},
  {id:"old", label:"Old Optimizer"},
  {id:"new", label:"New Optimizer"},
  {id:"settings", label:"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"},
];

let activeTab="dash";

function renderTabs(){
  const el=document.getElementById("tabs");
  el.innerHTML="";
  TABS.forEach(t=>{
    const b=document.createElement("div");
    b.className="tab"+(activeTab===t.id?" active":"");
    b.textContent=t.label;
    b.onclick=()=>setTab(t.id);
    el.appendChild(b);
  });
}

function setTab(id){
  activeTab=id;
  document.getElementById("tab-dash").style.display = (id==="dash")?"":"none";
  document.getElementById("tab-input").style.display = (id==="input")?"":"none";
  document.getElementById("tab-old").style.display = (id==="old")?"":"none";
  document.getElementById("tab-new").style.display = (id==="new")?"":"none";
  document.getElementById("tab-settings").style.display = (id==="settings")?"":"none";
  renderTabs();
  renderAll(false);
}

function fillMonthSelect(){
  const sel=document.getElementById("monthKey");
  sel.innerHTML="";
  state.historyOrder.forEach(k=>{
    if(!state.months[k]) state.months[k]=emptyMonth(k);
    const o=document.createElement("option");
    o.value=k; o.textContent=monthLabel(k);
    sel.appendChild(o);
  });
  sel.value=state.activeMonth;

  const base=document.getElementById("newBaseMonth");
  base.innerHTML="";
  state.historyOrder.forEach(k=>{
    const o=document.createElement("option");
    o.value=k; o.textContent=monthLabel(k);
    base.appendChild(o);
  });
  const idx=state.historyOrder.indexOf(state.activeMonth);
  base.value = (idx>0? state.historyOrder[idx-1] : state.activeMonth);
}

function fillWeekSelect(){
  const m=getMonth();
  const wsel=document.getElementById("weekSel");
  const cur=n(wsel.value||0);
  wsel.innerHTML="";
  for(let i=0;i<n(m.weeksInMonth);i++){
    const o=document.createElement("option");
    o.value=i; o.textContent=`–¢–∏–∂–¥–µ–Ω—å ${i+1}`;
    wsel.appendChild(o);
  }
  wsel.value = String(clamp(cur,0,n(m.weeksInMonth)-1));
}

function syncHeaderControls(){
  const m=getMonth();
  document.getElementById("weeksInMonth").value=String(m.weeksInMonth);
  document.getElementById("kpiMode").value=m.kpiMode;
  document.getElementById("planSales").value=m.planSales;
  document.getElementById("planTLeads").value=m.planTLeads;
  document.getElementById("planBudget").value=m.planBudget;
  document.getElementById("pasteModeLbl").textContent = state.pasteHot ? "–£–í–Ü–ú–ö" : "–í–ò–ú–ö";
}

function renderAll(rebuildSheet){
  fillMonthSelect();
  fillWeekSelect();
  syncHeaderControls();

  if(activeTab==="dash") renderDash();
  if(activeTab==="input"){
    if(rebuildSheet) buildSheet();
    else refreshSheetValues();
  }
  if(activeTab==="settings") renderSettings();
  if(activeTab==="old") renderOldTab();
  if(activeTab==="new") renderNewTab();

  updateEditUI();
  renderCloudPill();
  lockInputs();
}

/* =========================================================
   12) OLD/NEW renders
========================================================= */
let lastOldPlan=null;
let lastNewPlan=null;

function renderOldTab(){
  const ctx=document.getElementById("chartOld").getContext("2d");
  if(!lastOldPlan){
    drawGroupedBars(ctx, ["‚Äî"], [{label:"‚Äî", color:"rgba(107,183,184,.85)", data:[0]}], "‚Äî", "Old Optimizer (–Ω–µ–º–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É)");
    return;
  }
  const month=getMonth();
  const labels=GROUPS.map(g=>g.name.replace(" (Search/PMax/YT)",""));
  const budget=GROUPS.map(g=>n(lastOldPlan.add[g.key]?.budget));
  const leads=GROUPS.map(g=>n(lastOldPlan.add[g.key]?.leads));
  const kpi=GROUPS.map(g=>n(lastOldPlan.add[g.key]?.kpi));
  drawGroupedBars(ctx, labels, [
    {label:"–ë—é–¥–∂–µ—Ç", color:"rgba(107,183,184,.85)", data:budget},
    {label:"–õ—ñ–¥–∏", color:"rgba(138,125,255,.75)", data:leads},
    {label: month.kpiMode==="sales"?"KPI(–ø—Ä–æ–¥–∞–∂—ñ)":"KPI(—Ü—ñ–ª—å–æ–≤—ñ)", color:"rgba(255,204,102,.78)", data:kpi},
  ], "–∑–Ω–∞—á–µ–Ω–Ω—è", "Old Optimizer: –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö");
}

function renderNewTab(){
  const ctx=document.getElementById("chartNew").getContext("2d");
  if(!lastNewPlan){
    drawGroupedBars(ctx, ["‚Äî"], [{label:"‚Äî", color:"rgba(107,183,184,.85)", data:[0]}], "‚Äî", "New Optimizer (–Ω–µ–º–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É)");
    return;
  }
  const month=getMonth();
  const labels=GROUPS.map(g=>g.name.replace(" (Search/PMax/YT)",""));
  const budget=GROUPS.map(g=>n(lastNewPlan.add[g.key]?.budget));
  const leads=GROUPS.map(g=>n(lastNewPlan.add[g.key]?.leads));
  const kpi=GROUPS.map(g=>n(lastNewPlan.add[g.key]?.kpi));
  drawGroupedBars(ctx, labels, [
    {label:"–ë—é–¥–∂–µ—Ç", color:"rgba(107,183,184,.85)", data:budget},
    {label:"–õ—ñ–¥–∏", color:"rgba(138,125,255,.75)", data:leads},
    {label: month.kpiMode==="sales"?"KPI(–ø—Ä–æ–¥–∞–∂—ñ)":"KPI(—Ü—ñ–ª—å–æ–≤—ñ)", color:"rgba(255,204,102,.78)", data:kpi},
  ], "–∑–Ω–∞—á–µ–Ω–Ω—è", "New Optimizer: –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö");
}

/* =========================================================
   13) DIRTY + CLOUD PUSH/PULL
========================================================= */
let autoPushTimer=null;

function markDirty(){
  saveLocalState();
  if(activeTab==="dash") renderDash();
  if(activeTab==="input") refreshSheetValues();
  if(activeTab==="old") renderOldTab();
  if(activeTab==="new") renderNewTab();
  if(activeTab==="settings") renderSettings();

  if(isEditUnlocked()){
    clearTimeout(autoPushTimer);
    autoPushTimer=setTimeout(async ()=>{ await cloudPush(false); }, 2000);
  }
}

async function cloudPull(showToast=true){
  setCloudStatus("pulling","–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é‚Ä¶");
  const res=await cloudLoad();
  if(res.ok && res.state){
    state=res.state;
    saveLocalState();
    state.cloudMeta.lastPullAt=Date.now();
    state.cloudMeta.status="ok";
    state.cloudMeta.msg="pull ok";
    saveLocalState();
    renderAll(true);
    if(showToast) toast("‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ Cloud.");
    return true;
  }else{
    state.cloudMeta.status="error";
    state.cloudMeta.msg="pull failed";
    saveLocalState();
    renderCloudPill();
    if(showToast) toast("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ Cloud. –ü–µ—Ä–µ–≤—ñ—Ä –¥–æ—Å—Ç—É–ø/—Å–∫—Ä–∏–ø—Ç.");
    return false;
  }
}

async function cloudPush(showToast=true){
  if(!isEditUnlocked()){
    if(showToast) toast("üîí –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –°–ø–µ—Ä—à—É –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å.");
    return false;
  }
  setCloudStatus("pushing","–∑–±–µ—Ä—ñ–≥–∞—é‚Ä¶");
  try{
    const res=await cloudSave(state);
    state.cloudMeta.lastPushAt=Date.now();
    state.cloudMeta.status = res.ok ? "ok" : "warn";
    state.cloudMeta.msg = res.ok ? "push ok" : "push maybe";
    saveLocalState();
    renderCloudPill();
    if(showToast) toast(res.ok ? "‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Cloud." : "‚ö†Ô∏è –í—ñ–¥–ø–æ–≤—ñ–¥—å Cloud –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞, –∞–ª–µ –¥–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.");
    return true;
  }catch(e){
    state.cloudMeta.status="error";
    state.cloudMeta.msg="push failed";
    saveLocalState();
    renderCloudPill();
    if(showToast) toast("‚ùå –ü–æ–º–∏–ª–∫–∞ Cloud Push. –ü–µ—Ä–µ–≤—ñ—Ä Apps Script.");
    return false;
  }
}

/* =========================================================
   14) EXPORT / IMPORT / RESET / HELP
========================================================= */
function downloadJson(filename, obj){
  const blob=new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 50);
}

function doExport(){
  downloadJson(`binokl_marketing_os_v3_${state.activeMonth}.json`, state);
  toast("‚úÖ –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ JSON.");
}

function doImport(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      const s=normalizeState(obj);
      state=s;
      saveLocalState();
      renderAll(true);
      toast("‚úÖ –Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ JSON.");
    }catch(e){
      toast("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏. –§–∞–π–ª –Ω–µ —Å—Ö–æ–∂–∏–π –Ω–∞ state.");
    }
  };
  reader.readAsText(file);
}

function doReset(){
  if(!isEditUnlocked()){
    toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.");
    return;
  }
  if(!confirm("–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–æ —á–∏—Å—Ç–æ–≥–æ state? (Cloud –Ω–µ —á—ñ–ø–∞—î–º–æ)")) return;
  state=freshState();
  saveLocalState();
  renderAll(true);
  toast("‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ —Å–∫–∏–Ω—É—Ç–æ.");
}

function showHelp(){
  toast(
    `<b>–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å:</b><br>
     1) –û–±–µ—Ä–∏ –º—ñ—Å—è—Ü—å ‚Üí KPI ‚Üí —Ç–∏–∂–Ω—ñ–≤.<br>
     2) –í–∫–ª–∞–¥–∫–∞ <b>–í–≤—ñ–¥</b>: –∑–∞–ø–æ–≤–Ω–∏ –ø–ª–∞–Ω –ø–æ –∫–∞–Ω–∞–ª–∞—Ö + —Ñ–∞–∫—Ç —Ç–∏–∂–Ω—è (Ctrl+V –∑ Sheets).<br>
     3) –ù–∞ <b>–î–∞—à–±–æ—Ä–¥—ñ</b>: –¥–∏–≤–∏—Å—å —Ç–µ–º–ø/–≤—É–∑—å–∫–µ –º—ñ—Å—Ü–µ, —ñ –Ω–∞—Ç–∏—Å–∫–∞–π <b>–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ü—ñ—é</b>.<br>
     4) <b>Old</b> ‚Äî —Å—É—Ö–∏–π baseline. <b>New</b> ‚Äî –≤—ñ–¥ —Ñ–∞–∫—Ç—É –º–∏–Ω—É–ª–æ–≥–æ –º—ñ—Å—è—Ü—è (blending).<br>
     5) –ü—ñ—Å–ª—è –∑–º—ñ–Ω (–∫–æ–ª–∏ Edit ON) –¥–∞–Ω—ñ –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è –≤ Cloud —á–µ—Ä–µ–∑ ~2 —Å–µ–∫—É–Ω–¥–∏.`,
    6800
  );
}

/* =========================================================
   15) FIX + CALIBRATE
========================================================= */
let lastFix=null;

function calcFix(){
  const fx=weeklyFix();
  lastFix=fx;
  state.lastWeeklyFix = { at: Date.now(), month: state.activeMonth, ok: fx.ok, bottle: fx.bottle||null };
  saveLocalState();
  document.getElementById("fixBox").innerHTML = fx.ok ? fx.msg : ("‚ùå " + fx.msg);
  toast("‚úÖ –ö–æ—Ä–µ–∫—Ü—ñ—é –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–æ.");
}

function applyFix(){
  if(!isEditUnlocked()){
    toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.");
    return;
  }
  if(!lastFix || !lastFix.add){
    toast("‚ÑπÔ∏è –ù–µ–º–∞ —á–æ–≥–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ (–∞–±–æ –≤—É–∑—å–∫–µ –º—ñ—Å—Ü–µ CR).");
    return;
  }
  applyWeeklyFix(lastFix);
  markDirty();
  toast("‚úÖ –ö–æ—Ä–µ–∫—Ü—ñ—é –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤ –ø–ª–∞–Ω.");
}

function autoCalibrateFromFact(){
  if(!isEditUnlocked()){
    toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.");
    return;
  }
  const mk=state.activeMonth;
  const {month, used} = computeMonth(mk);
  if(used<=0){
    toast("‚ÑπÔ∏è –ù–µ–º–∞ —Ñ–∞–∫—Ç—É. –°–ø–µ—Ä—à—É –≤–Ω–µ—Å–∏ —Ö–æ—á–∞ –± 1 —Ç–∏–∂–¥–µ–Ω—å.");
    return;
  }
  if(!confirm("–ê–≤—Ç–æ–∫–∞–ª—ñ–±—Ä—É–≤–∞—Ç–∏ –ø–ª–∞–Ω–æ–≤—ñ CPL/Q/CR –ø–æ –∫–∞–Ω–∞–ª–∞—Ö –∑ —Ñ–∞–∫—Ç—É? –¶–µ –º–æ–∂–µ –ª–∞–º–∞—Ç–∏ –º–æ–¥–µ–ª—å, —è–∫—â–æ —Ñ–∞–∫—Ç ‚Äú–∫—Ä–∏–≤–∏–π‚Äù. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) return;

  const m=getMonth();
  m.groups.forEach(gr=>{
    const f=sumFactForGroup(gr, used);
    // –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —É–º–æ–≤–∏, —â–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ –¥—É—Ä–Ω—é
    if(f.leads>=15 && isFinite(f.cpl) && f.cpl>0) gr.planCPL = f.cpl;
    if(f.leads>=20 && isFinite(f.q) && f.q>0) gr.planQ = clamp(f.q,0,1);
    if(f.tLeads>=10 && isFinite(f.cr) && f.cr>0) gr.planCR = clamp(f.cr,0,1);
  });

  markDirty();
  toast("‚úÖ –ê–≤—Ç–æ–∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ (–æ–±–µ—Ä–µ–∂–Ω–æ).");
}

/* =========================================================
   16) PASSWORD MODAL
========================================================= */
function openPwModal(){
  const m=document.getElementById("pwModal");
  const inp=document.getElementById("pwInput");
  inp.value="";
  m.style.display="grid";
  setTimeout(()=>inp.focus(), 0);
}
function closePwModal(){
  document.getElementById("pwModal").style.display="none";
}

async function unlockWithPassword(){
  const pw=document.getElementById("pwInput").value||"";
  const h=await sha256Hex(pw);
  if(h===ADMIN_PASSWORD_SHA256_HEX){
    setEditUnlocked(true);
    closePwModal();
    toast("‚úÖ –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ.");
  }else{
    toast("‚ùå –ü–∞—Ä–æ–ª—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.");
  }
}

/* =========================================================
   17) EVENTS
========================================================= */
function bindEvents(){
  document.getElementById("btnHelp").onclick=showHelp;

  document.getElementById("btnUnlock").onclick=()=>openPwModal();
  document.getElementById("btnLock").onclick=()=>{
    setEditUnlocked(false);
    toast("üîí –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ.");
  };

  document.getElementById("pwCancel").onclick=closePwModal;
  document.getElementById("pwOk").onclick=unlockWithPassword;
  document.getElementById("pwInput").addEventListener("keydown",(e)=>{
    if(e.key==="Enter") unlockWithPassword();
    if(e.key==="Escape") closePwModal();
  });
  document.getElementById("pwModal").addEventListener("click",(e)=>{
    if(e.target.id==="pwModal") closePwModal();
  });

  document.getElementById("btnCloudPull").onclick=()=>cloudPull(true);
  document.getElementById("btnCloudPush").onclick=()=>cloudPush(true);

  document.getElementById("btnExport").onclick=doExport;
  document.getElementById("btnImport").onclick=()=>document.getElementById("fileImport").click();
  document.getElementById("fileImport").onchange=(e)=>{
    const f=e.target.files && e.target.files[0];
    if(f) doImport(f);
    e.target.value="";
  };

  document.getElementById("btnReset").onclick=doReset;

  document.getElementById("monthKey").onchange=(e)=>{
    state.activeMonth=e.target.value;
    saveLocalState();
    // –ø—Ä–∏ –∑–º—ñ–Ω—ñ –º—ñ—Å—è—Ü—è: –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–∫–∏ —Ç–∏–∂–Ω—ñ–≤/—Ç–∞–±–ª–∏—á–∫—É
    renderAll(true);
  };

  document.getElementById("weekSel").onchange=()=>{
    if(activeTab==="input") refreshSheetValues();
    if(activeTab==="dash") renderDash();
  };

  document.getElementById("weeksInMonth").onchange=(e)=>{
    if(!isEditUnlocked()){ renderAll(true); return; }
    const m=getMonth();
    m.weeksInMonth = n(e.target.value)===5 ? 5 : 4;
    // —è–∫—â–æ —Ç–∏–∂–Ω—ñ–≤ —Å—Ç–∞–ª–æ –º–µ–Ω—à–µ ‚Äî —Ç—Ä–∏–º–∞—î–º–æ —Å–µ–ª–µ–∫—Ç —É –º–µ–∂–∞—Ö
    fillWeekSelect();
    markDirty();
  };

  document.getElementById("kpiMode").onchange=(e)=>{
    if(!isEditUnlocked()){ renderAll(true); return; }
    const m=getMonth();
    m.kpiMode = e.target.value==="tlead" ? "tlead" : "sales";
    markDirty();
  };

  document.getElementById("planSales").oninput=debounce((e)=>{
    if(!isEditUnlocked()) return;
    getMonth().planSales = Math.max(0, n(e.target.value));
    markDirty();
  },120);
  document.getElementById("planTLeads").oninput=debounce((e)=>{
    if(!isEditUnlocked()) return;
    getMonth().planTLeads = Math.max(0, n(e.target.value));
    markDirty();
  },120);
  document.getElementById("planBudget").oninput=debounce((e)=>{
    if(!isEditUnlocked()) return;
    getMonth().planBudget = Math.max(0, n(e.target.value));
    markDirty();
  },120);

  document.getElementById("btnRecalc").onclick=()=>{
    // –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º—É—Å–æ–≤–æ –ø–µ—Ä–µ–º–∞–ª—é–≤–∞—Ç–∏ + —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ —ñ–Ω–ø—É—Ç–∏ –≤ state, —è–∫—â–æ unlocked
    if(isEditUnlocked()){
      const m=getMonth();
      m.planSales = Math.max(0, n(document.getElementById("planSales").value));
      m.planTLeads = Math.max(0, n(document.getElementById("planTLeads").value));
      m.planBudget = Math.max(0, n(document.getElementById("planBudget").value));
      m.kpiMode = document.getElementById("kpiMode").value==="tlead" ? "tlead" : "sales";
      m.weeksInMonth = n(document.getElementById("weeksInMonth").value)===5 ? 5 : 4;
      fillWeekSelect();
      markDirty();
    }else{
      renderAll(false);
      toast("‚ÑπÔ∏è –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ ‚Äî –æ–∫, –∞–ª–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ.");
    }
  };

  // Weekly fix
  document.getElementById("btnFixCalc").onclick=()=>calcFix();
  document.getElementById("btnFixApply").onclick=()=>applyFix();

  // Paste toggle
  document.getElementById("btnPasteMode").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    state.pasteHot = !state.pasteHot;
    saveLocalState();
    syncHeaderControls();
    toast(state.pasteHot ? "‚úÖ –í—Å—Ç–∞–≤–∫–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–∞." : "‚úÖ –í—Å—Ç–∞–≤–∫–∞ –≤–∏–º–∫–Ω–µ–Ω–∞.");
  };

  // Clear week
  document.getElementById("btnClearWeek").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    const m=getMonth();
    const w=currentWeekIndex();
    if(!confirm(`–û–±–Ω—É–ª–∏—Ç–∏ —Ñ–∞–∫—Ç –¥–ª—è —Ç–∏–∂–Ω—è ${w+1}?`)) return;
    m.groups.forEach(g=>{
      g.weeks[w].budget=0;
      g.weeks[w].leads=0;
      g.weeks[w].q=g.planQ || BASE_MODEL[g.key].q;
      g.weeks[w].sales=0;
    });
    markDirty();
    refreshSheetValues();
    toast("‚úÖ –¢–∏–∂–¥–µ–Ω—å –æ–±–Ω—É–ª–µ–Ω–æ.");
  };

  // Old optimizer
  document.getElementById("btnOldPreview").onclick=()=>{
    lastOldPlan = oldOptimizerPlan(state.activeMonth);
    const m=getMonth();
    document.getElementById("oldBox").innerHTML =
      `–¶—ñ–ª—å: <b>${fmt.num(lastOldPlan.targetKPI,2)}</b> KPI, –±—é–¥–∂–µ—Ç-–∫–∞–ø: <b>${m.planBudget>0?fmt.uah(m.planBudget):"–Ω–µ–º–∞"}</b>.<br>
       –ü–ª–∞–Ω –¥–∞—î KPI‚âà<b>${fmt.num(lastOldPlan.total.kpi,2)}</b>, –±—é–¥–∂–µ—Ç‚âà<b>${fmt.uah(lastOldPlan.total.budget)}</b>, –ª—ñ–¥—ñ–≤‚âà<b>${fmt.int(lastOldPlan.total.leads)}</b>.<br>
       –ó–∞–ª–∏—à–æ–∫ KPI (—è–∫—â–æ >0): <b>${fmt.num(Math.max(0,lastOldPlan.needLeft),2)}</b>.`;
    renderOldTab();
    toast("‚úÖ Old Optimizer –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–æ.");
  };
  document.getElementById("btnOldApply").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    if(!lastOldPlan){ toast("‚ÑπÔ∏è –°–ø–µ—Ä—à—É –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏‚Äù."); return; }
    applyPlanToMonth(lastOldPlan);
    markDirty();
    if(activeTab==="input") refreshSheetValues();
    toast("‚úÖ Old –ø–ª–∞–Ω –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ.");
  };

  // New optimizer
  document.getElementById("btnNewPreview").onclick=()=>{
    const base=document.getElementById("newBaseMonth").value || state.activeMonth;
    const blend=document.getElementById("blendMode").value || "70_30";
    lastNewPlan = newOptimizerPlan(state.activeMonth, base, blend);
    const m=getMonth();
    document.getElementById("newBox").innerHTML =
      `–ë–∞–∑–∞: <b>${monthLabel(base)}</b>, –∑–º—ñ—à—É–≤–∞–Ω–Ω—è: <b>${blend}</b>.<br>
       –¶—ñ–ª—å KPI: <b>${fmt.num(lastNewPlan.targetKPI,2)}</b>, –±—é–¥–∂–µ—Ç-–∫–∞–ø: <b>${m.planBudget>0?fmt.uah(m.planBudget):"–Ω–µ–º–∞"}</b>.<br>
       –ü–ª–∞–Ω –¥–∞—î KPI‚âà<b>${fmt.num(lastNewPlan.total.kpi,2)}</b>, –±—é–¥–∂–µ—Ç‚âà<b>${fmt.uah(lastNewPlan.total.budget)}</b>, –ª—ñ–¥—ñ–≤‚âà<b>${fmt.int(lastNewPlan.total.leads)}</b>.`;
    renderNewTab();
    toast("‚úÖ New Optimizer –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–æ.");
  };
  document.getElementById("btnNewApply").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    if(!lastNewPlan){ toast("‚ÑπÔ∏è –°–ø–µ—Ä—à—É –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏‚Äù."); return; }
    applyPlanToMonth(lastNewPlan);
    markDirty();
    if(activeTab==="input") refreshSheetValues();
    toast("‚úÖ New –ø–ª–∞–Ω –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ.");
  };

  // Quick apply from Input tab
  document.getElementById("btnPlanOld").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    lastOldPlan = oldOptimizerPlan(state.activeMonth);
    applyPlanToMonth(lastOldPlan);
    markDirty();
    refreshSheetValues();
    toast("‚úÖ Old Optimizer –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —É –ø–ª–∞–Ω.");
  };
  document.getElementById("btnPlanNew").onclick=()=>{
    if(!isEditUnlocked()){ toast("üîí –°–ø–µ—Ä—à—É —Ä–æ–∑–±–ª–æ–∫—É–π —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."); return; }
    const base=document.getElementById("newBaseMonth").value || state.activeMonth;
    const blend=document.getElementById("blendMode").value || "70_30";
    lastNewPlan = newOptimizerPlan(state.activeMonth, base, blend);
    applyPlanToMonth(lastNewPlan);
    markDirty();
    refreshSheetValues();
    toast("‚úÖ New Optimizer –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —É –ø–ª–∞–Ω.");
  };

  // Calibrate
  document.getElementById("btnAutoCalibrate").onclick=autoCalibrateFromFact;
}

/* =========================================================
   18) INIT
========================================================= */
function init(){
  renderTabs();
  renderAll(true);
  bindEvents();
  // –ª–µ–≥–∫–∏–π –∞–≤—Ç–æ–ø—É–ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (–±–µ–∑ —à—É–º—É)
  cloudPull(false);
}

init();
</script>
</body>
</html>
